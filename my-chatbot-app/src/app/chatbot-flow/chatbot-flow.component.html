<div class="chatbot-flow-container">
  <div class="header">
    <div class="header-left">
      <h2>Create Story</h2>
    </div>
    <div class="header-actions">
      <button
        mat-raised-button
        color="primary"
        class="save-button"
        (click)="saveFlow()"
      >
        Save
      </button>
    </div>
  </div>

  <div class="main-content">
    <div class="left-sidebar">
      <div class="sidebar-header">
        <p class="instruction-text">
          Drag blocks to the node tree below using the drag handle
        </p>
      </div>

      <div class="search-container">
        <mat-form-field class="search-field">
          <mat-icon matPrefix>search</mat-icon>
          <input
            matInput
            placeholder="Search..."
            [formControl]="searchControl"
          />
        </mat-form-field>
      </div>

      <div class="blocks-list" cdkDropList [cdkDropListConnectedTo]="[canvasDropList]" (cdkDropListDropped)="drop($event)">
        <div
          *ngFor="let block of filteredBlocks$ | async"
          class="block-item"
          cdkDrag
          [cdkDragData]="block"
        >
          <div
            class="block-icon"
            [style.background-color]="getStatusColor(block.status)"
          >
            <img *ngIf="block.imageUrl" [src]="block.imageUrl" alt="block-icon" class="custom-icon shadow-sm border border-gray-200 rounded">
            <mat-icon *ngIf="!block.imageUrl">{{ block.icon }}</mat-icon>
          </div>

          <div class="block-content flex items-center">
            <div class="block-name">{{ block.name }}</div>
            <div
              *ngIf="block.description"
              class="block-description ml-2 px-1.5 py-1 rounded-md bg-green-500 text-white text-xs font-semibold"
            >
              {{ block.description }}
            </div>
          </div>

          <div class="drag-handle">
            <mat-icon>drag_indicator</mat-icon>
          </div>

          <!-- Ghost preview while dragging -->
          <ng-template cdkDragPreview>
            <div class="drag-preview px-4 py-2 rounded-md shadow-lg border bg-white opacity-90 text-sm font-medium">
              {{ block.name }}
            </div>
          </ng-template>
        </div>
      </div>
    </div>
    <div class="canvas-area" [class.sidebar-open]="rightSidebarOpen">
      <div class="canvas-controls">
        <div class="zoom-controls">
          <button
            mat-icon-button
            (click)="zoomIn()"
            [disabled]="zoomLevel >= maxZoom"
          >
            <mat-icon class="mt-2 mr-0.9">add</mat-icon>
          </button>
          <span class="zoom-level"
            >{{ zoomLevel * 100 | number : "1.0-0" }}%</span
          >
          <button
            mat-icon-button
            (click)="zoomOut()"
            [disabled]="zoomLevel <= minZoom"
          >
            <mat-icon class="mt-2 mr-0.9">remove</mat-icon>
          </button>
        </div>
        <button mat-icon-button (click)="resetZoom()" matTooltip="Reset zoom">
          <span class="reset-text">Reset</span>
        </button>
      </div>

      <div
        class="canvas-wrapper bg-[#F1F2F3]"
        #canvasWrapper
        cdkDropList
        #canvasDropList="cdkDropList" cdkDropListSortingDisabled="true"
        [style.cursor]="isPanning ? 'grabbing' : 'default'"
        (cdkDropListDropped)="onBlockDropped($event)"
      >
        <div class="canvas-content" #canvasContent id="canvas">
          <div class="flow-start-indicator">
            <div class="flow-start-text">Flow starts here</div>
            <div class="flow-start-arrow">
              <mat-icon>arrow_downward</mat-icon>
            </div>
          </div>

          <div class="blocks-container">
            <div
              *ngFor="let block of canvasBlocks"
              class="canvas-block jsplumb-draggable"
              [id]="'block-' + block.id"
              [class]="'canvas-block-' + block.type"
              [class.selected]="selectedBlock?.id === block.id"
              [class.dragging]="isDraggingBlock && draggedBlockId === block.id"
              [style.left.px]="block.x"
              [style.top.px]="block.y"
              [style.border-color]="getStatusColor(block.status)"
              [style.background-color]="getTypeColor(block.type)"
              cdkDrag
              (cdkDragStarted)="onBlockDragStarted($event, block)"
              (cdkDragEnded)="onBlockDragEnded($event, block)"
              (mousedown)="endConnection($event, block)"
              [cdkDragFreeDragPosition]="{x: 0, y: 0}" >
              <ng-container [ngSwitch]="block.type">
                <app-user-input-block
                  *ngSwitchCase="'userInput'"
                  [block]="block"
                  [attr.id]="'user-input-block-' + block.id"
                  [isSelected]="selectedBlock?.id === block.id"
                  [isSidebarOpen]="rightSidebarOpen"
                  (blockUpdated)="onBlockUpdated($event)"
                  (selectBlock)="selectBlock($event)"
                  (startConnection)="startConnection($event, block)"
                  (endConnection)="endConnection($event, block)"
                  (removeBlock)="removeCanvasBlock($event)"
                  (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"
                  (addKeywordGroupBlock)="onAddKeywordGroupBlockToCanvas()"
                ></app-user-input-block>

                <app-text-response-block
                  *ngSwitchCase="'textResponse'"
                  [block]="block"
                  [isSelected]="selectedBlock?.id === block.id"
                  [isSidebarOpen]="rightSidebarOpen"
                  (blockUpdated)="onBlockUpdated($event)"
                  (selectBlock)="selectBlock($event)"
                  (startConnection)="startConnection($event, block)"
                  (endConnection)="endConnection($event, block)"
                  (removeBlock)="removeCanvasBlock($event)"
                  (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"
                  (addKeywordGroupBlock)="onAddKeywordGroupBlockToCanvas()"
                ></app-text-response-block>

                <app-media-block
                  *ngSwitchCase="'mediaBlock'"
                  [attr.id]="'media-block-' + block.id"
                  [block]="block"
                  [isSelected]="selectedBlock?.id === block.id"
                  [isSidebarOpen]="rightSidebarOpen"
                  [availableMedia]="availableMedia"
                  (blockUpdated)="onBlockUpdated($event)"
                  (selectBlock)="selectBlock($event)"
                  (startConnection)="startConnection($event, block)"
                  (endConnection)="endConnection($event, block)"
                  (removeBlock)="removeCanvasBlock($event)"
                  (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"
                ></app-media-block>

                <app-link-story-block
                  *ngSwitchCase="'linkStory'"
                  [block]="block"
                  [isSelected]="selectedBlock?.id === block.id"
                  [isSidebarOpen]="rightSidebarOpen"
                  [availableStories]="availableStories"
                  (blockUpdated)="onBlockUpdated($event)"
                  (selectBlock)="selectBlock($event)"
                  (startConnection)="startConnection($event, block)"
                  (endConnection)="endConnection($event, block)"
                  (removeBlock)="removeCanvasBlock($event)"
                  (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"
                ></app-link-story-block>

                <app-conversational-form-block
                  *ngSwitchCase="'conversationalForm'"
                  [block]="block"
                  [isSelected]="selectedBlock?.id === block.id"
                  [isSidebarOpen]="rightSidebarOpen"
                  [availableForms]="availableForms"
                  (blockUpdated)="onBlockUpdated($event)"
                  (selectBlock)="selectBlock($event)"
                  (startConnection)="startConnection($event, block)"
                  (endConnection)="endConnection($event, block)"
                  (removeBlock)="removeCanvasBlock($event)"
                  (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"
                ></app-conversational-form-block>

                <app-typing-delay-block
                  *ngSwitchCase="'typingDelay'"
                  [block]="block"
                  [isSelected]="selectedBlock?.id === block.id"
                  [isSidebarOpen]="rightSidebarOpen"
                  (blockUpdated)="onBlockUpdated($event)"
                  (selectBlock)="selectBlock($event)"
                  (startConnection)="startConnection($event, block)"
                  (endConnection)="endConnection($event, block)"
                  (removeBlock)="removeCanvasBlock($event)"
                  (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"
                ></app-typing-delay-block>

                <app-json-api-integration-block
                  *ngSwitchDefault
                  [block]="block"
                  [isSelected]="selectedBlock?.id === block.id"
                  [isSidebarOpen]="rightSidebarOpen"
                  (blockUpdated)="onBlockUpdated($event)"
                  (selectBlock)="selectBlock($event)"
                  (startConnection)="startConnection($event, block)"
                  (endConnection)="endConnection($event, block)"
                  (removeBlock)="removeCanvasBlock($event)"
                  (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"
                ></app-json-api-integration-block>
              </ng-container>
            </div>
            
            <div
              *ngFor="let block of canvasBlocks"
              class="quick-reply-cards-wrapper"
              [class.hidden]="
                block.type !== 'textResponse' ||
                !block.quickReplies ||
                block.quickReplies.length === 0
              "
            >
              <svg
                class="quick-reply-connections-svg"
                [attr.width]="1200"
                [attr.height]="400"
              >
                <path
                  [attr.d]="
                    'M ' +
                    (block.x + (block.width || 280) / 2) +
                    ',' +
                    ((block.y || 0) + (block.height || 150)) +
                    ' L ' +
                    (block.x - 180 + 140) +
                    ',' +
                    ((block.y || 0) + (block.height || 150) + 60)
                  "
                  class="connection-line no-quick-reply-connection"
                ></path>

                <path
                  [attr.d]="
                    'M ' +
                    (block.x + (block.width || 280) / 2) +
                    ',' +
                    ((block.y || 0) + (block.height || 150)) +
                    ' L ' +
                    (block.x + 130 + 140) +
                    ',' +
                    ((block.y || 0) + (block.height || 150) + 60)
                  "
                  class="connection-line quick-replies-connection"
                ></path>

                <g *ngFor="let reply of block.quickReplies; let i = index">
                  <path
                    [attr.d]="
                      'M ' +
                      (block.x + 130 + 140) +
                      ',' +
                      ((block.y || 0) + (block.height || 150) + 60 + 75) +
                      ' L ' +
                      (block.x - 100 + i * 250 + 110) +
                      ',' +
                      ((block.y || 0) + (block.height || 150) + 200)
                    "
                    class="connection-line individual-quick-reply-connection"
                  ></path>
                </g>
              </svg>

              <div
                class="no-quick-reply-block-external"
                [style.left.px]="block.x - 180"
                [style.top.px]="(block.y || 0) + (block.height || 150) + 60"
              >
                <div class="flow-block-header">
                  <mat-icon class="block-icon">block</mat-icon>
                  <span class="block-title">No Quick Reply</span>
                </div>
                <div class="flow-block-body">
                  <p class="block-description">
                    Drag modules from the user input tab
                  </p>
                </div>
                <div class="connection-point connection-output">
                  <div class="connection-dot"></div>
                </div>
              </div>

              <div
                class="quick-replies-main-block-external"
                [style.left.px]="block.x + 130"
                [style.top.px]="(block.y || 0) + (block.height || 150) + 60"
              >
                <div class="flow-block-header">
                  <mat-icon class="block-icon">forum</mat-icon>
                  <span class="block-title">Quick Replies</span>
                </div>
                <div class="flow-block-body">
                  <p class="block-description">
                    Simple buttons to carry forward the user conversation to a
                    desired path
                  </p>
                </div>
                <div class="connection-point connection-output">
                  <div class="connection-dot"></div>
                </div>
              </div>

              <div
                class="individual-quick-replies-external"
                [style.left.px]="block.x - 100"
                [style.top.px]="(block.y || 0) + (block.height || 150) + 200"
              >
                <div class="quick-reply-cards-row">
                  <div
                    *ngFor="let reply of block.quickReplies; let i = index"
                    class="individual-quick-reply-card"
                    [style.left.px]="i * 250"
                  >
                    <div class="quick-reply-card-header">
                      <div class="quick-reply-icon-wrapper">
                        <mat-icon class="quick-reply-icon"
                          >chat_bubble</mat-icon
                        >
                      </div>
                      <span class="quick-reply-title">Quick Reply:</span>
                      <div class="quick-reply-badge">{{ reply.text }}</div>
                    </div>
                    <div class="connection-point connection-output">
                      <div class="connection-dot"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="right-sidebar"
      [class.open]="rightSidebarOpen"
      *ngIf="selectedBlock"
    >
      <div class="right-sidebar-header">
        <div class="sidebar-title">
          <mat-icon>{{ selectedBlock.icon }}</mat-icon>
          <span>{{ selectedBlock.name }}</span>
        </div>
        <button mat-icon-button (click)="closeSidebar()" class="close-btn">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="right-sidebar-content-wrapper">
        <ng-container [ngSwitch]="selectedBlock.type">
          <app-user-input-block
            *ngSwitchCase="'userInput'"
            [block]="selectedBlock"
            [isSelected]="true"
            [isSidebarOpen]="true"
            (blockUpdated)="onBlockUpdated($event)"
            (closeSidebarEvent)="closeSidebar()"
            (editBlock)="editCanvasBlock($event)"
          ></app-user-input-block>

          <app-text-response-block
            *ngSwitchCase="'textResponse'"
            [block]="selectedBlock"
            [isSelected]="true"
            [isSidebarOpen]="true"
            (blockUpdated)="onBlockUpdated($event)"
            (closeSidebarEvent)="closeSidebar()"
            (editBlock)="editCanvasBlock($event)"
          ></app-text-response-block>

          <app-media-block
            *ngSwitchCase="'mediaBlock'"
            [block]="selectedBlock"
            [isSelected]="true"
            [isSidebarOpen]="true"
            [availableMedia]="availableMedia"
            (closeSidebarEvent)="closeSidebar()"
            (blockUpdated)="onBlockUpdated($event)"
          ></app-media-block>

          <app-link-story-block
            *ngSwitchCase="'linkStory'"
            [block]="selectedBlock"
            [isSelected]="true"
            [isSidebarOpen]="true"
            [availableStories]="availableStories"
            (blockUpdated)="onBlockUpdated($event)"
          ></app-link-story-block>

          <app-conversational-form-block
            *ngSwitchCase="'conversationalForm'"
            [block]="selectedBlock"
            [isSelected]="true"
            [isSidebarOpen]="true"
            [availableForms]="availableForms"
            (blockUpdated)="onBlockUpdated($event)"
          ></app-conversational-form-block>

          <app-typing-delay-block
            *ngSwitchCase="'typingDelay'"
            [block]="selectedBlock"
            [isSelected]="true"
            [isSidebarOpen]="true"
            (blockUpdated)="onBlockUpdated($event)"
          ></app-typing-delay-block>

          <app-json-api-integration-block
            *ngIf="selectedBlock.type === 'jsonApi'"
            [block]="selectedBlock"
            [isSelected]="true"
            (blockUpdated)="onBlockUpdated($event)"
          ></app-json-api-integration-block>
        </ng-container>
      </div>
    </div>

    <div
      class="sidebar-overlay"
      [class.active]="rightSidebarOpen"
      (click)="closeSidebar()"
    ></div>

    <app-message-box
      *ngIf="showMessageBox"
      [message]="messageBoxContent"
      [type]="messageBoxType"
      (closed)="onMessageBoxClosed()"
    ></app-message-box>
  </div>

  <app-jarvish-block *ngIf="isJarvisVisible" [canvasBlocks]="canvasBlocks"></app-jarvish-block>

  <button class="absolute right-10 bottom-8 w-14 cursor-pointer z-[100000]" (click)="toggleJarvis()">
    <img src="/msg.png" alt="" class="rounded-full">
  </button>
</div>