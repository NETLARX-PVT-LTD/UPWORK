<ng-container *ngIf="!isSelected">
  <div class="block-container">
    <div class="block-header">
      <div class="block-type-badges">
        <div class="block-title" (click)="onSelectBlock()">
          <img
            src="https://app.botsify.com/theme/images/Story-Icons/form.png"
            alt="block icon"
            class="block-icon"
          />
          <span>{{ block.name }}</span>
        </div>
        <span class="selected-form-badge" *ngIf="block.formName">{{
          block.formName
        }}</span>
      </div>

      <div class="block-close-icon">
        <button
          mat-icon-button
          class="close-btn"
          (click)="onRemoveBlock()"
          aria-label="Remove Block"
        >
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <div class="block-body">
      <div *ngIf="block.formFields?.length">
        <p class="text-[#515365] mt-2">Fields:</p>
        <div class="mt-1 flex flex-wrap gap-2">
          <button
            *ngFor="let field of block.formFields"
            class="bg-green-500 text-white text-[12px] px-1 py-1 rounded hover:bg-green-600 transition"
          >
            {{ field.name }}
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<div class="right-sidebar-content" *ngIf="isSelected && isSidebarOpen">
  <div class="panel-header">
    <div class="panel-subtitle text-[#888ea8] font-[600] mt-3">
      Ask one question at a time & send responses to your desired location or
      webservice
    </div>
  </div>

  <div class="panel-content mt-5">
    <div
      class="section-container"
      *ngIf="!showNewFormForm && !showFormConfigMode"
    >
      <div class="section-content space-y-3">
        <label class="block text-[14px] font-[700] mb-2 text-[#506690]"
          >Conversational Form Integration</label
        >
        <div class="select-container">
          <input
            type="text"
            class="custom-select"
            [(ngModel)]="searchQuery"
            (ngModelChange)="onSearchQueryChange()"
            (focus)="showDropdown = true"
            (blur)="onInputBlur()"
            placeholder="Select a Conversational Form"
          />

          <ul class="dropdown-list" *ngIf="showDropdown">
            <li
              *ngFor="let form of filteredForms"
              (mousedown)="selectForm(form)"
            >
              {{ form.name }}
            </li>
          </ul>
        </div>

        <div class="setting-item flex items-center gap-3">
          <label class="switch s-success mr-2">
            <input
              type="checkbox"
              [(ngModel)]="block.showAsInlineForm"
              (change)="onContentChange()"
            />
            <span class="slider round"></span>
          </label>
          <span
            class="text-[14px] text-[#506690] font-[600] items-center flex gap-2"
            >Show as inline form
            <mat-icon
              matTooltip="Inline form does not work on facebook"
              class="info-icon cursor-help color-[#9e9e9e]"
              >info</mat-icon
            >
          </span>
        </div>

        <div class="setting-item flex items-center gap-3">
          <label class="switch s-success mr-2">
            <input
              type="checkbox"
              [(ngModel)]="block.renderFormResponses"
              (change)="onContentChange()"
            />
            <span class="slider round"></span>
          </label>
          <div class="setting-info">
            <div class="setting-label text-[14px] font-[600] text-[#506690]">
              Render form responses
            </div>
          </div>
        </div>
        <div
          class="selected-form-info flex flex-col gap-2"
          *ngIf="block.formId; else nextTemplate"
        >
          <div
            class="or-separator text-center my-5 font-semibold text-gray-600 relative"
          >
            <span class="text-black text-l">OR</span>
          </div>

          <!-- Buttons -->
          <div class="flex gap-2">
            <button
              mat-flat-button
              class="create-new-form-button w-1/2"
              (click)="createNewFormBlock()"
            >
              <!-- <mat-icon>add</mat-icon> -->
              Create New Conversational Form
            </button>
            <button
              *ngIf="block.formId"
              mat-stroked-button
              class="edit-form-button w-1/2"
              (click)="editExistingFormBlock()"
            >
              Edit Form
            </button>
          </div>
        </div>
        <ng-template #nextTemplate>
          <div class="divider text-center">
            <span>OR</span>
          </div>

          <div class="flex gap-2">
            <button
              mat-flat-button
              class="create-new-form-button w-full"
              (click)="createNewFormBlock()"
            >
              <!-- <mat-icon>add</mat-icon> -->
              Create New Conversational Form
            </button>
          </div>
        </ng-template>
      </div>
    </div>

    <div class="section-container" *ngIf="showNewFormForm">
      <div class="section-content">
        <div class="form-basic-info">
          <label for="form-name" class="text-[#506690] font-semibold  ">Form Name</label>
          <input
          id="form-name"
            type="text"
            class="w-full mt-2 px-4 py-2 border-1 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[rgba(194,213,255,0.619608)] focus:border-[#1b55e2] focus:shadow-[0_0_5px_2px_rgba(194,213,255,0.619608)] mb-2 placeholder-gray-500 placeholder-opacity-50"
            required
            #formName="ngModel"
            [(ngModel)]="block.formName"
            (ngModelChange)="onContentChange()"
            placeholder="Enter the form name"
          />
          <div
            class="error-message text-red-900 text-[13px] mb-2 ml-2"
            *ngIf="formName.invalid && formName.touched"
          >
            Form name is required.
          </div>
        </div>

        <!-- one of the things contains here -->
        <div class="form-fields-section mt-2 ">
          <!-- One of the things contains here -->
          <!-- <div class="form-fields-container"> -->
          <div
            *ngFor="let field of block.formFields; let i = index"
            class="form-field-card "
          >
            <div class="field-header bg-[#ecefff]">
              <div class="field-title">
                Form Field
                #{{ i + 1 }}
              </div>
              <div class="field-actions">
                <button
                  mat-icon-button
                  [disabled]="i === 0"
                  (click)="moveFieldUp(i)"
                  matTooltip="Move up"
                >
                  <mat-icon>keyboard_arrow_up</mat-icon>
                </button>
                <button
                  mat-icon-button
                  [disabled]="i === (block.formFields?.length || 0) - 1"
                  (click)="moveFieldDown(i)"
                  matTooltip="Move down"
                >
                  <mat-icon>keyboard_arrow_down</mat-icon>
                </button>
                <button
                  mat-icon-button
                  color="warn"
                  (click)="removeFormField(i)"
                  matTooltip="Delete field"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <div class="field-content bg-[#ecefff]">
              <label for="field-name" class="text-[#506690] font-semibold">Label</label>
              <input
              id="field-name"
                type="text"
                class="w-full bg-white mt-2 mb-3 px-4 py-2 border-1 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[rgba(194,213,255,0.619608)] focus:border-[#1b55e2] focus:shadow-[0_0_5px_2px_rgba(194,213,255,0.619608)] placeholder-gray-500 placeholder-opacity-50"
                [(ngModel)]="field.name"
                (ngModelChange)="onContentChange()"
                placeholder="Field Name e.g., Name"
              />
              <label for="prompt-phrase" class="text-[#506690] font-semibold">Prompt Phrase</label>
              <input
              id="prompt-phrase"
                type="text"
                class="w-full  bg-white mt-2 mb-3 px-4 py-2 border-1 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[rgba(194,213,255,0.619608)] focus:border-[#1b55e2] focus:shadow-[0_0_5px_2px_rgba(194,213,255,0.619608)] placeholder-gray-500 placeholder-opacity-50"
                [(ngModel)]="field.promptPhrase"
                (ngModelChange)="onContentChange()"
                placeholder="e.g., What's your name?"
              />

              <div class="full-width-input">
                <label for="inputType" class="block  text-[#506690] font-semibold">Input Type</label>
                <select
                  id="inputType"
                  class="
                  bg-white
                    mt-1
                    block
                    w-full 
                    px-4 
                    py-2 
                    border-1 
                    border-gray-300 
                    rounded-md 
                    focus:outline-none 
                    focus:ring-2 
                    focus:ring-[rgba(194,213,255,0.619608)] 
                    focus:border-[#1b55e2] 
                    focus:shadow-[0_0_5px_2px_rgba(194,213,255,0.619608)]
                    placeholder-gray-500 placeholder-opacity-50
                  "
                  [(ngModel)]="field.type"
                  (ngModelChange)="onContentChange()"
                >
                  <option value="text">Text</option>
                  <option value="email">Email</option>
                  <option value="number">Number</option>
                  <option value="phone">Phone</option>
                  <option value="date">Date</option>
                  <option value="datetime">Date & Time</option>
                  <option value="options">Single Choice</option>
                  <option value="multiple-options">Multiple Choice</option>
                  <option value="file">File Upload</option>
                  <option value="image">Image Upload</option>
                  <option value="url">URL</option>
                  <option value="currency">Currency</option>
                  <option value="geocode">Location</option>
                </select>
              </div>

              <div
                *ngIf="
                  field.type === 'options' || field.type === 'multiple-options'
                "
                class="field-options"
              >
              <div class="full-width-input">
                <label for="options" class="block text-[#506690] font-semibold">Multiple Options</label>
                <input
                  id="options"
                  class="
                   bg-white
                    mt-1
                    block
                    w-full 
                    px-4 
                    py-2 
                    border-2 
                    border-gray-300 
                    rounded-md 
                    focus:outline-none 
                    focus:ring-2 
                    focus:ring-[rgba(194,213,255,0.619608)] 
                    focus:border-[#1b55e2] 
                    focus:shadow-[0_0_5px_2px_rgba(194,213,255,0.619608)]
                    placeholder-gray-500 
                    placeholder-opacity-50
                  "
                  [(ngModel)]="field.optionsText"
                  (ngModelChange)="updateFieldOptions(field)"
                  placeholder="add options"
                  rows="3"
                >
              </div>
              </div>

              <div class="field-settings">
                <div class="flex items-center space-x-2 mt-5 ml-2">
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input 
                      type="checkbox" 
                      class="sr-only peer" 
                      [(ngModel)]="field.required" 
                      (ngModelChange)="onContentChange()"
                    />
                    <div 
                      class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-[#c2d5ff] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"
                    ></div>
                  </label>
                  <span class="font-semibold text-[#506690]">Required</span>
                </div>
              </div>
            </div>
          </div>
          <!-- </div> -->

          <button
            mat-stroked-button
            class="add-field-button"
            (click)="addFormField()"
          >
            <mat-icon>add</mat-icon>
            Add Field
          </button>
        </div>

        <div class="form-actions-container">
          <div class="form-actions">
            <button mat-button (click)="cancelFormEdit()">Cancel</button>
            <button
              mat-flat-button
              color="primary"
              (click)="goToNextSection()"
              [disabled]="formName.invalid"
            >
              Next
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="showFormConfigMode" class="form-configuration space-y-5">
      <div class="form-name-section bg-white shadow-xl h-[90px] p-5 rounded-lg">
        <mat-form-field appearance="outline" class="full-width-input">
          <!-- <mat-label>Form Name</mat-label> -->
          <input
            matInput
            [(ngModel)]="block.formName"
            (ngModelChange)="onContentChange()"
            readonly
          />
        </mat-form-field>
      </div>

      <div class="bg-white shadow-xl flex flex-col gap-4 px-5 py-8 rounded-lg">
        <mat-expansion-panel
          [expanded]="expandedSection === 'onFormSubmit'"
          (opened)="expandedSection = 'onFormSubmit'"
        >
          <mat-expansion-panel-header>
            <mat-panel-title>
              <!-- <mat-icon>send</mat-icon> -->
              <span class="text-blue-800">On Form Submit</span>
            </mat-panel-title>
            <!-- <mat-panel-description>
            <mat-icon>keyboard_arrow_down</mat-icon>
          </mat-panel-description> -->
          </mat-expansion-panel-header>

          <div class="section-content space-y-2">
            <div class="setting-item flex items-center gap-2">
              <mat-slide-toggle
                [(ngModel)]="block.callApiWithResponseData"
                (ngModelChange)="onContentChange()"
              >
              </mat-slide-toggle>
              <div class="setting-info">
                <div class="setting-label text-lg font-[600]">
                  Call API with response data
                </div>
              </div>
            </div>

            <div class="api-config-form" *ngIf="block.callApiWithResponseData">
              <mat-form-field appearance="outline" class="full-width-input">
                <!-- <mat-label>API URL</mat-label> -->
                <input
                  matInput
                  type="url"
                  [(ngModel)]="block.apiUrl"
                  (ngModelChange)="onContentChange()"
                  placeholder="https://your-api.com/endpoint"
                />
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width-input">
                <mat-label>Method</mat-label>
                <mat-select
                  [(ngModel)]="block.apiMethod"
                  (ngModelChange)="onContentChange()"
                >
                  <mat-option value="GET">GET</mat-option>
                  <mat-option value="POST">POST</mat-option>
                  <mat-option value="PUT">PUT</mat-option>
                  <mat-option value="DELETE">DELETE</mat-option>
                  <mat-option value="PATCH">PATCH</mat-option>
                </mat-select>
              </mat-form-field>

              <div class="headers-section">
                <div class="section-header flex gap-2">
                  <h4>Headers</h4>
                  <mat-icon
                    matTooltip="Add custom headers for your API request"
                    class="info-icon"
                    >info</mat-icon
                  >
                </div>
                <div
                  class="header-item"
                  *ngFor="let header of block.apiHeaders; let i = index"
                >
                  <mat-form-field
                    appearance="outline"
                    class="header-key-input w-full"
                  >
                    <!-- <mat-label>Header Key</mat-label> -->
                    <input
                      matInput
                      [(ngModel)]="header.key"
                      (ngModelChange)="onContentChange()"
                      placeholder="Header Key : Authorization"
                    />
                  </mat-form-field>
                  <mat-form-field
                    appearance="outline"
                    class="header-value-input w-[80%]"
                  >
                    <!-- <mat-label>Header Value</mat-label> -->
                    <input
                      matInput
                      [(ngModel)]="header.value"
                      (ngModelChange)="onContentChange()"
                      placeholder="Header Value"
                    />
                  </mat-form-field>
                  <button
                    mat-icon-button
                    (click)="removeApiHeader(i)"
                    matTooltip="Remove Header"
                  >
                    <mat-icon class="">delete</mat-icon>
                  </button>
                </div>
                <button
                  mat-stroked-button
                  class="add-header-button"
                  (click)="addApiHeader()"
                >
                  <mat-icon>add</mat-icon>
                  Add Header
                </button>
              </div>
            </div>
            <div class="setting-item flex items-center gap-2">
              <mat-slide-toggle
                [(ngModel)]="block.sendEmailNotification"
                (ngModelChange)="onContentChange()"
              >
              </mat-slide-toggle>
              <div class="setting-info">
                <div class="setting-label text-lg font-[600]">
                  Email me responses
                </div>
              </div>
            </div>

            <mat-form-field
              appearance="outline"
              class="full-width-input"
              *ngIf="block.sendEmailNotification"
            >
              <mat-label>Notification Email</mat-label>
              <input
                matInput
                type="email"
                [(ngModel)]="block.notificationEmail"
                (ngModelChange)="onContentChange()"
                placeholder="admin@company.com"
              />
            </mat-form-field>
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel
          [expanded]="expandedSection === 'basicSettings'"
          (opened)="expandedSection = 'basicSettings'"
        >
          <mat-expansion-panel-header>
            <mat-panel-title>
              <!-- <mat-icon>settings</mat-icon> -->
              <span>Basic Settings</span>
            </mat-panel-title>
            <mat-panel-description>
              <!-- <mat-icon>keyboard_arrow_down</mat-icon> -->
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="section-content">
            <div class="settings-group space-y-2">
              <div class="setting-item">
                <div class="setting-info flex items-center gap-4">
                  <mat-slide-toggle
                    [(ngModel)]="block.allowMultipleSubmission"
                    (ngModelChange)="onContentChange()"
                  >
                  </mat-slide-toggle>
                  <div class="setting-label text-lg font-[600]">
                    Allow Multiple Submission
                  </div>
                  <!-- <div class="setting-description">
                    Message when a user tries to submit the form multiple times.
                  </div> -->
                </div>
              </div>

              <mat-form-field
                appearance="outline"
                class="full-width-input mt-3"
                *ngIf="!block.allowMultipleSubmission"
              >
                <mat-label
                  >Message when a user tries to submit the form multiple
                  times.</mat-label
                >
                <input
                  matInput
                  [(ngModel)]="block.multipleSubmissionMessage"
                  (ngModelChange)="onContentChange()"
                />
              </mat-form-field>

              <div class="setting-item">
                <div class="setting-info flex items-center gap-4">
                  <mat-slide-toggle
                    [(ngModel)]="block.allowExitForm"
                    (ngModelChange)="onContentChange()"
                  >
                  </mat-slide-toggle>
                  <div class="setting-label text-lg font-[600]">
                    Let the user exit the form?
                  </div>
                </div>
              </div>

              <mat-form-field
                appearance="outline"
                class="full-width-input mt-3"
                *ngIf="block.allowExitForm"
              >
                <mat-label
                  >Message To Send When User Exits Form (optional)</mat-label
                >
                <input
                  matInput
                  [(ngModel)]="block.exitFormMessage"
                  (ngModelChange)="onContentChange()"
                  placeholder="you exit the form"
                />
              </mat-form-field>
            </div>
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel
          [expanded]="expandedSection === 'advanceSettings'"
          (opened)="expandedSection = 'advanceSettings'"
          class="block-config-panel"
        >
          <mat-expansion-panel-header>
            <mat-panel-title> Advance Settings </mat-panel-title>
          </mat-expansion-panel-header>

          <p class="section-description text-xs mb-2 text-[#888EAB]">
            If you have API enabled, bot will instead respond with the API
            response.
          </p>

          <div class="button-group-responsive mb-2">
            <button
              class="px-4 py-2 bg-[#366CF4] shadow-l rounded"
              (click)="
                block.successResponseType = 'textMessage'; onContentChange()
              "
              [ngClass]="
                block.successResponseType === 'textMessage'
                  ? 'bg-[#366CF4] text-white'
                  : 'bg-white text-black'
              "
            >
              Text Message
            </button>
            <button
              (click)="block.successResponseType = 'story'; onContentChange()"
              [ngClass]="
                block.successResponseType === 'story'
                  ? 'bg-[#366CF4] text-white'
                  : 'bg-white text-black'
              "
              class="px-4 py-2 rounded shadow-l transition duration-200"
            >
              Story
            </button>
          </div>

          <mat-form-field
            appearance="outline"
            class="full-width-input"
            *ngIf="block.successResponseType === 'textMessage'"
          >
            <!-- <mat-label>Success Message</mat-label> -->
            <textarea
              matInput
              [(ngModel)]="block.successMessage"
              (ngModelChange)="onContentChange()"
              placeholder="Thanks for the submission"
              rows="3"
            ></textarea>
            <mat-icon
              matSuffix
              class="info-icon"
              matTooltip="This message will be displayed to the user upon successful form submission."
              [matMenuTriggerFor]="variableMenu"
            >
              info
            </mat-icon>
          </mat-form-field>

          <mat-menu #variableMenu="matMenu">
            <div class="variable-card-content">
              <div class="search-input-container">
                <mat-icon>search</mat-icon>
                <input matInput placeholder="Search variable" />
              </div>
              <div class="variable-group">
                <div class="group-header">General Attributes</div>
                <button
                  mat-menu-item
                  (click)="insertVariableIntoSuccessMessage('[first_name]')"
                >
                  [first_name]
                </button>
                <button
                  mat-menu-item
                  (click)="insertVariableIntoSuccessMessage('[last_name]')"
                >
                  [last_name]
                </button>
                <button
                  mat-menu-item
                  (click)="insertVariableIntoSuccessMessage('[timezone]')"
                >
                  [timezone]
                </button>
                <button
                  mat-menu-item
                  (click)="insertVariableIntoSuccessMessage('[gender]')"
                >
                  [gender]
                </button>
              </div>
              <div class="variable-group">
                <div class="group-header">Form Fields</div>
                <button
                  mat-menu-item
                  *ngFor="let field of block.formFields"
                  (click)="
                    insertVariableIntoSuccessMessage(
                      '{{form.' + field.name + '}}'
                    )
                  "
                >
                  {{ '{{form.' + field.name + '}}' }}
                </button>
              </div>
            </div>
          </mat-menu>

          <mat-form-field
            appearance="outline"
            class="full-width-input"
            *ngIf="block.successResponseType === 'story'"
          >
            <mat-label>Select Your Story</mat-label>
            <mat-select
              [(ngModel)]="block.successRedirectStoryId"
              (ngModelChange)="onContentChange()"
            >
              <mat-option
                *ngFor="let story of availableStories"
                [value]="story.id"
              >
                {{ story.name }}
              </mat-option>
            </mat-select>
            <mat-icon
              matSuffix
              class="info-icon"
              matTooltip="The bot will redirect to this story after successful form submission."
              >info</mat-icon
            >
          </mat-form-field>
        </mat-expansion-panel>
      </div>

      <div
        class="bottom-actions bg-white shadow-xl flex justify-between px-5 py-4 rounded-lg"
      >
        <button
          class="px-5 py-2 bg-[#2E66F4] text-white rounded cursor-pointer"
          color="primary"
          (click)="editExistingFormBlock()"
        >
          <!-- <mat-icon>arrow_back</mat-icon> -->
          Previous
        </button>
        <button
          class="px-5 py-2 bg-[#2E66F4] text-white rounded cursor-pointer"
          color="primary"
          (click)="saveForm()"
        >
          Save
        </button>
      </div>
    </div>
  </div>
</div>
