<div class="block-header">
  <div class="block-type-badges">
    <div class="block-title" (click)="onSelectBlock()">
      <mat-icon class="block-icon">{{ block.icon }}</mat-icon>
      <span>{{ block.name }}</span>
    </div>
    <span *ngIf="block.formId" class="badge form-block-badge">
      Selected Form: {{ getFormName(block.formId) }}
    </span>
  </div>

  <div class="block-actions">
    <button
      mat-icon-button
      [matMenuTriggerFor]="blockMenu"
      class="block-menu-trigger"
    >
      <mat-icon>more_vert</mat-icon>
    </button>
    <mat-menu #blockMenu="matMenu">
      <button mat-menu-item (click)="onEditBlock()">
        <mat-icon>edit</mat-icon>
        <span>Edit</span>
      </button>
      <button mat-menu-item (click)="onDuplicateBlock()">
        <mat-icon>content_copy</mat-icon>
        <span>Duplicate</span>
      </button>
      <button mat-menu-item (click)="onRemoveBlock()">
        <mat-icon>delete</mat-icon>
        <span>Delete</span>
      </button>
    </mat-menu>
  </div>
</div>

<div class="block-body">
  <div class="block-description" *ngIf="block.description">
    {{ block.description }}
  </div>

  <div class="block-content-text" *ngIf="block.formName">
    Form: {{ block.formName }}
  </div>
  <div class="block-content-text" *ngIf="!block.formName">
    No form selected.
  </div>

  <div class="right-sidebar-content">
    <h4 class="section-title">Conversational Form Integration</h4>
    <p class="config-description">
      Ask one question at a time & send responses to your desired location or
      webservice.
    </p>

    <div *ngIf="!showNewFormForm">
      <div class="input-group">
        <mat-form-field appearance="outline" class="full-width-input">
          <mat-label>Select a Conversational Form</mat-label>
          <mat-select
            [(ngModel)]="block.formId"
            (selectionChange)="onFormSelectionChange()"
          >
            <mat-option *ngFor="let form of availableForms" [value]="form.id">
              {{ form.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="d-flex align-items-center mt-2">
        <mat-slide-toggle
          [(ngModel)]="block.showAsInlineForm"
          (ngModelChange)="onContentChange()"
        >
          Show as inline form
        </mat-slide-toggle>
        <mat-icon
          matTooltip="When selected, the form will be sent in a full page message in the chat window, otherwise it will display as individual messages."
          class="info-icon ml-1"
          >info</mat-icon
        >
      </div>

      <div class="d-flex align-items-center mt-2">
        <mat-slide-toggle
          [(ngModel)]="block.renderFormResponses"
          (ngModelChange)="onContentChange()"
        >
          Render form responses
        </mat-slide-toggle>
        <mat-icon
          matTooltip="When selected, each form response will be sent as a separate message to the user."
          class="info-icon ml-1"
          >info</mat-icon
        >
      </div>

      <div class="or-separator">OR</div>
      <button
        mat-flat-button
        color="primary"
        class="create-new-form-button"
        (click)="createNewFormBlock()"
      >
        Create New Conversational Form
      </button>
    </div>

    <div
      class="d-flex justify-content-between align-items-center mt-3"
      *ngIf="block.formId && !showNewFormForm"
    >
      <div class="selected-form-name">
        <strong>Selected:</strong> {{ getFormName(block.formId) }}
      </div>
      <button
        mat-flat-button
        color="primary"
        class="edit-form-button"
        (click)="editExistingFormBlock()"
      >
        Edit Conversational Form
      </button>
    </div>

    <div *ngIf="showNewFormForm">
      <h5 class="sub-section-title">Define Conversational Form</h5>
      <mat-form-field appearance="outline" class="full-width-input">
        <mat-label>Form Name</mat-label>
        <input
          matInput
          [(ngModel)]="block.formName"
          (ngModelChange)="onContentChange()"
          placeholder="e.g., Contact Us Form"
        />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width-input mt-3">
        <mat-label>Webhook URL (optional)</mat-label>
        <input
          matInput
          type="url"
          [(ngModel)]="block.webhookUrl"
          (ngModelChange)="onContentChange()"
          placeholder="e.g., https://your-webhook.com/endpoint"
        />
      </mat-form-field>

      <mat-checkbox
        class="mt-3"
        [(ngModel)]="block.sendEmailNotification"
        (ngModelChange)="onContentChange()"
      >
        Send email notification
      </mat-checkbox>
      <mat-form-field
        appearance="outline"
        class="full-width-input mt-3"
        *ngIf="block.sendEmailNotification"
      >
        <mat-label>Email Address</mat-label>
        <input
          matInput
          type="email"
          [(ngModel)]="block.notificationEmail"
          (ngModelChange)="onContentChange()"
          placeholder="e.g., recipient@example.com"
        />
      </mat-form-field>

      <h6 class="sub-section-title mt-4">Form Fields</h6>
      <div
        *ngFor="let field of block.formFields; let i = index"
        class="form-field-item"
      >
        <div class="d-flex justify-content-between align-items-center form-field-header">
          <strong>Form Field #{{ i + 1 }}</strong>
          <div>
            <button mat-icon-button><mat-icon>keyboard_arrow_up</mat-icon></button>
            <button mat-icon-button><mat-icon>keyboard_arrow_down</mat-icon></button>
            <button mat-icon-button color="warn" (click)="removeFormField(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>

        <mat-form-field appearance="outline" class="full-width-input">
          <mat-label>Label</mat-label>
          <input
            matInput
            [(ngModel)]="field.name"
            (ngModelChange)="onContentChange()"
            placeholder="e.g., Name"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width-input mt-2">
          <mat-label>Prompt Phrase</mat-label>
          <input
            matInput
            [(ngModel)]="field.promptPhrase"
            (ngModelChange)="onContentChange()"
            placeholder="e.g., Enter your name"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width-input mt-2">
  <mat-label>Input Type</mat-label>
  <mat-select
    [(ngModel)]="field.type"
    (ngModelChange)="onContentChange()"
  >
    <mat-option value="text">Text</mat-option>
    <mat-option value="email">Email</mat-option>
    <mat-option value="number">Number</mat-option>
    <mat-option value="options">Options</mat-option>
    <mat-option value="phone">Phone</mat-option>
    <mat-option value="image">Image</mat-option>
    <mat-option value="datetime">DateTime</mat-option>
    <mat-option value="currency">Currency</mat-option>
    <mat-option value="url">URL</mat-option>
    <mat-option value="geocode">Geocode</mat-option>
    <mat-option value="file">File</mat-option>
    <mat-option value="date">Date</mat-option>
    <mat-option value="multiple-options">Multiple Options</mat-option>
  </mat-select>
</mat-form-field>

        <div class="d-flex align-items-center mt-2">
          <mat-slide-toggle
            [(ngModel)]="field.required"
            (ngModelChange)="onContentChange()"
          >
            Required
          </mat-slide-toggle>
        </div>
      </div>
      <button mat-stroked-button class="add-field-button" (click)="addFormField()">
        <mat-icon>add</mat-icon> Add Field
      </button>

      <div class="d-flex justify-content-end mt-3">
        <button mat-button (click)="cancelFormEdit()">Cancel</button>
        <button mat-flat-button color="primary" class="ml-2">Save Form</button>
      </div>
    </div>
  </div>
</div>

<div
  class="connection-point connection-output"
  (mousedown)="onStartConnection($event)"
>
  <div class="connection-dot"></div>
</div>

<div class="connection-point connection-input">
  <div class="connection-dot"></div>
</div>