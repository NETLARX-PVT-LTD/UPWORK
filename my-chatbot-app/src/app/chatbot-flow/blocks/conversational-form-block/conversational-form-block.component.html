<div class="right-panel" *ngIf="block">
  <div class="panel-header">
    <div class="panel-subtitle">
     Ask one question at a time & send responses to your desired location or webservice
    </div>
  </div>

  <div class="panel-content">
    <div class="section-container" *ngIf="!showNewFormForm && !showFormConfigMode">
  <div class="section-content">
    <mat-form-field appearance="outline" class="full-width-input">
      <mat-label>Select a Conversational Form</mat-label>
      <mat-select
        [(ngModel)]="block.formId"
        (selectionChange)="onFormSelectionChange()"
      >
        <mat-option *ngFor="let form of availableForms" [value]="form.id">
          {{ form.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">Show as inline form</div>
      </div>
      <mat-slide-toggle
        [(ngModel)]="block.showAsInlineForm"
        (ngModelChange)="onContentChange()"
      >
      </mat-slide-toggle>
    </div>

    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">Render form responses</div>
      </div>
      <mat-slide-toggle
        [(ngModel)]="block.renderFormResponses"
        (ngModelChange)="onContentChange()"
      >
      </mat-slide-toggle>
    </div>
    <div class="selected-form-info" *ngIf="block.formId">
      <div class="selected-form-badge">
        <mat-icon>check_circle</mat-icon>
        <span>Selected: {{ getFormName(block.formId) }}</span>
      </div>
      <button
        mat-stroked-button
        color="primary"
        class="edit-form-button"
        (click)="editExistingFormBlock()"
      >
        <mat-icon>edit</mat-icon>
        Edit Form
      </button>
    </div>

    <div class="divider">
      <span>OR</span>
    </div>

    <button
      mat-flat-button
      color="primary"
      class="create-new-form-button"
      (click)="createNewFormBlock()"
    >
      <mat-icon>add</mat-icon>
      Create New Conversational Form
    </button>
  </div>
</div>

    <div class="section-container" *ngIf="showNewFormForm">
      <div class="section-content">
        <div class="form-basic-info">
          <mat-form-field appearance="outline" class="full-width-input">
            <mat-label>Form Name</mat-label>
            <input
              matInput
              [(ngModel)]="block.formName"
              (ngModelChange)="onContentChange()"
              placeholder="e.g., Contact Us Form"
            />
          </mat-form-field>

        </div>

        <div class="form-fields-section">
          <div class="section-header">
            <h4>Form Fields</h4>
            <mat-icon matTooltip="Add fields to collect information from users"
              class="info-icon">info</mat-icon
            >
          </div>

          <div class="form-fields-container">
            <div
              *ngFor="let field of block.formFields; let i = index"
              class="form-field-card"
            >
              <div class="field-header">
                <div class="field-number">{{ i + 1 }}</div>
                <div class="field-title">{{ field.name || 'Untitled Field' }}</div>
                <div class="field-actions">
                  <button
                    mat-icon-button
                    [disabled]="i === 0"
                    (click)="moveFieldUp(i)"
                    matTooltip="Move up"
                  >
                    <mat-icon>keyboard_arrow_up</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    [disabled]="i === (block.formFields?.length || 0) - 1"
                    (click)="moveFieldDown(i)"
                    matTooltip="Move down"
                  >
                    <mat-icon>keyboard_arrow_down</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="removeFormField(i)"
                    matTooltip="Delete field"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              <div class="field-content">
                <mat-form-field appearance="outline" class="full-width-input">
                  <mat-label>Field Label</mat-label>
                  <input
                    matInput
                    [(ngModel)]="field.name"
                    (ngModelChange)="onContentChange()"
                    placeholder="e.g., Name"
                  />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width-input">
                  <mat-label>Prompt Message</mat-label>
                  <input
                    matInput
                    [(ngModel)]="field.promptPhrase"
                    (ngModelChange)="onContentChange()"
                    placeholder="e.g., What's your name?"
                  />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width-input">
                  <mat-label>Field Type</mat-label>
                  <mat-select
                    [(ngModel)]="field.type"
                    (ngModelChange)="onContentChange()"
                  >
                    <mat-option value="text">Text</mat-option>
                    <mat-option value="email">Email</mat-option>
                    <mat-option value="number">Number</mat-option>
                    <mat-option value="phone">Phone</mat-option>
                    <mat-option value="date">Date</mat-option>
                    <mat-option value="datetime">Date & Time</mat-option>
                    <mat-option value="options">Single Choice</mat-option>
                    <mat-option value="multiple-options">Multiple Choice</mat-option>
                    <mat-option value="file">File Upload</mat-option>
                    <mat-option value="image">Image Upload</mat-option>
                    <mat-option value="url">URL</mat-option>
                    <mat-option value="currency">Currency</mat-option>
                    <mat-option value="geocode">Location</mat-option>
                  </mat-select>
                </mat-form-field>

                <div
                  *ngIf="field.type === 'options' || field.type === 'multiple-options'"
                  class="field-options"
                >
                  <mat-form-field appearance="outline" class="full-width-input">
                    <mat-label>Options (comma separated)</mat-label>
                    <textarea
                      matInput
                      [(ngModel)]="field.optionsText"
                      (ngModelChange)="updateFieldOptions(field)"
                      placeholder="Option 1, Option 2, Option 3"
                      rows="3"
                    ></textarea>
                  </mat-form-field>
                </div>

                <div class="field-settings">
                  <mat-checkbox
                    [(ngModel)]="field.required"
                    (ngModelChange)="onContentChange()"
                  >
                    Required field
                  </mat-checkbox>
                </div>
              </div>
            </div>
          </div>

          <button mat-stroked-button class="add-field-button" (click)="addFormField()">
            <mat-icon>add</mat-icon>
            Add Field
          </button>
        </div>

        <div class="form-actions-container">
          <div class="form-actions">
            <button mat-button (click)="cancelFormEdit()">Cancel</button>
            <button mat-flat-button color="primary" (click)="goToNextSection()">
              Next
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="showFormConfigMode" class="form-configuration">
      <div class="form-name-section">
        <mat-form-field appearance="outline" class="full-width-input">
          <mat-label>Form Name</mat-label>
          <input
            matInput
            [(ngModel)]="block.formName"
            (ngModelChange)="onContentChange()"
            readonly
          />
        </mat-form-field>
      </div>

      <mat-expansion-panel
  [expanded]="expandedSection === 'onFormSubmit'"
  (opened)="expandedSection = 'onFormSubmit'"
>
  <mat-expansion-panel-header>
    <mat-panel-title>
      <mat-icon>send</mat-icon>
      <span>On Form Submit</span>
    </mat-panel-title>
    <mat-panel-description>
      <mat-icon>keyboard_arrow_down</mat-icon>
    </mat-panel-description>
  </mat-expansion-panel-header>

  <div class="section-content">
    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">Call API with response data</div>
      </div>
      <mat-slide-toggle
        [(ngModel)]="block.callApiWithResponseData"
        (ngModelChange)="onContentChange()"
      >
      </mat-slide-toggle>
    </div>

    <div class="api-config-form" *ngIf="block.callApiWithResponseData">
      <mat-form-field appearance="outline" class="full-width-input">
        <mat-label>API URL</mat-label>
        <input
          matInput
          type="url"
          [(ngModel)]="block.apiUrl"
          (ngModelChange)="onContentChange()"
          placeholder="https://your-api.com/endpoint"
        />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width-input">
        <mat-label>Method</mat-label>
        <mat-select
          [(ngModel)]="block.apiMethod"
          (ngModelChange)="onContentChange()"
        >
          <mat-option value="GET">GET</mat-option>
          <mat-option value="POST">POST</mat-option>
          <mat-option value="PUT">PUT</mat-option>
          <mat-option value="DELETE">DELETE</mat-option>
          <mat-option value="PATCH">PATCH</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="headers-section">
        <div class="section-header">
          <h4>Headers</h4>
          <mat-icon matTooltip="Add custom headers for your API request" class="info-icon">info</mat-icon>
        </div>
        <div class="header-item" *ngFor="let header of block.apiHeaders; let i = index">
          <mat-form-field appearance="outline" class="header-key-input">
            <mat-label>Header Key</mat-label>
            <input
              matInput
              [(ngModel)]="header.key"
              (ngModelChange)="onContentChange()"
              placeholder="Authorization"
            />
          </mat-form-field>
          <mat-form-field appearance="outline" class="header-value-input">
            <mat-label>Header Value</mat-label>
            <input
              matInput
              [(ngModel)]="header.value"
              (ngModelChange)="onContentChange()"
              placeholder="Bearer your_token"
            />
          </mat-form-field>
          <button mat-icon-button color="warn" (click)="removeApiHeader(i)" matTooltip="Remove Header">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
        <button mat-stroked-button class="add-header-button" (click)="addApiHeader()">
          <mat-icon>add</mat-icon>
          Add Header
        </button>
      </div>
    </div>
    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">Email me responses</div>
      </div>
      <mat-slide-toggle
        [(ngModel)]="block.sendEmailNotification"
        (ngModelChange)="onContentChange()"
      >
      </mat-slide-toggle>
    </div>

    <mat-form-field
      appearance="outline"
      class="full-width-input"
      *ngIf="block.sendEmailNotification"
    >
      <mat-label>Notification Email</mat-label>
      <input
        matInput
        type="email"
        [(ngModel)]="block.notificationEmail"
        (ngModelChange)="onContentChange()"
        placeholder="admin@company.com"
      />
    </mat-form-field>
  </div>
</mat-expansion-panel>

      <mat-expansion-panel
        [expanded]="expandedSection === 'basicSettings'"
        (opened)="expandedSection = 'basicSettings'"
      >
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>settings</mat-icon>
            <span>Basic Settings</span>
          </mat-panel-title>
          <mat-panel-description>
            <mat-icon>keyboard_arrow_down</mat-icon>
          </mat-panel-description>
        </mat-expansion-panel-header>

        <div class="section-content">
          <div class="settings-group">
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Allow Multiple Submission</div>
                <div class="setting-description">
                  Message when a user tries to submit the form multiple times.
                </div>
              </div>
              <mat-slide-toggle
                [(ngModel)]="block.allowMultipleSubmission"
                (ngModelChange)="onContentChange()"
              >
              </mat-slide-toggle>
            </div>

            <mat-form-field
              appearance="outline"
              class="full-width-input"
              *ngIf="!block.allowMultipleSubmission"
            >
              <mat-label>Message when a user tries to submit the form multiple times.</mat-label>
              <input
                matInput
                [(ngModel)]="block.multipleSubmissionMessage"
                (ngModelChange)="onContentChange()"
              />
            </mat-form-field>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Let the user exit the form?</div>
              </div>
              <mat-slide-toggle
                [(ngModel)]="block.allowExitForm"
                (ngModelChange)="onContentChange()"
              >
              </mat-slide-toggle>
            </div>

            <mat-form-field
              appearance="outline"
              class="full-width-input"
              *ngIf="block.allowExitForm"
            >
              <mat-label>Message To Send When User Exits Form (optional)</mat-label>
              <input
                matInput
                [(ngModel)]="block.exitFormMessage"
                (ngModelChange)="onContentChange()"
                placeholder="you exit the form"
              />
            </mat-form-field>

            </div>
        </div>
      </mat-expansion-panel>

       <mat-expansion-panel
  [expanded]="expandedSection === 'advanceSettings'"
  (opened)="expandedSection = 'advanceSettings'"
  class="block-config-panel"
>
  <mat-expansion-panel-header>
    <mat-panel-title> Advance Settings </mat-panel-title>
  </mat-expansion-panel-header>

  <p class="section-description">
    If you have API enabled, bot will instead respond with the API response.
  </p>

  <div class="button-group-responsive">
    <button
      mat-flat-button
      [color]="block.successResponseType === 'textMessage' ? 'primary' : ''"
      (click)="block.successResponseType = 'textMessage'; onContentChange()"
    >
      Text Message
    </button>
    <button
      mat-flat-button
      [color]="block.successResponseType === 'story' ? 'primary' : ''"
      (click)="block.successResponseType = 'story'; onContentChange()"
    >
      Story
    </button>
  </div>

  <mat-form-field
    appearance="outline"
    class="full-width-input"
    *ngIf="block.successResponseType === 'textMessage'"
  >
    <mat-label>Success Message</mat-label>
    <textarea
      matInput
      [(ngModel)]="block.successMessage"
      (ngModelChange)="onContentChange()"
      placeholder="Thanks for the submission"
      rows="3"
    ></textarea>
    <mat-icon
      matSuffix
      class="info-icon"
      matTooltip="This message will be displayed to the user upon successful form submission."
      [matMenuTriggerFor]="variableMenu"
    >
      info
    </mat-icon>
    </mat-form-field>

  <mat-menu #variableMenu="matMenu">
    <div class="variable-card-content">
      <div class="search-input-container">
        <mat-icon>search</mat-icon>
        <input matInput placeholder="Search variable" />
      </div>
      <div class="variable-group">
        <div class="group-header">General Attributes</div>
        <button mat-menu-item (click)="insertVariableIntoSuccessMessage('[first_name]')">
          [first_name]
        </button>
        <button mat-menu-item (click)="insertVariableIntoSuccessMessage('[last_name]')">
          [last_name]
        </button>
        <button mat-menu-item (click)="insertVariableIntoSuccessMessage('[timezone]')">
          [timezone]
        </button>
        <button mat-menu-item (click)="insertVariableIntoSuccessMessage('[gender]')">
          [gender]
        </button>
      </div>
      <div class="variable-group">
        <div class="group-header">Form Fields</div>
        <button mat-menu-item *ngFor="let field of block.formFields" (click)="insertVariableIntoSuccessMessage('{{form.' + field.name + '}}')">
            {{ '{{form.' + field.name + '}}' }}
        </button>
      </div>
    </div>
  </mat-menu>

  <mat-form-field
    appearance="outline"
    class="full-width-input"
    *ngIf="block.successResponseType === 'story'"
  >
    <mat-label>Select Story</mat-label>
    <mat-select
      [(ngModel)]="block.successRedirectStoryId"
      (ngModelChange)="onContentChange()"
    >
      <mat-option *ngFor="let story of availableStories" [value]="story.id">
        {{ story.name }}
      </mat-option>
    </mat-select>
    <mat-icon
      matSuffix
      class="info-icon"
      matTooltip="The bot will redirect to this story after successful form submission."
      >info</mat-icon
    >
  </mat-form-field>
</mat-expansion-panel>

      <div class="bottom-actions">
        <button
          mat-stroked-button
          color="primary"
          (click)="editExistingFormBlock()"
        >
          <mat-icon>arrow_back</mat-icon>
          Previous
        </button>
        <button mat-flat-button color="primary" (click)="saveForm()">
          Save
        </button>
      </div>
    </div>
  </div>
</div>