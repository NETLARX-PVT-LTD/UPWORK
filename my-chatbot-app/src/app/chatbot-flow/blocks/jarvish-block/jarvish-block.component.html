<!-- Jarvis Chat Widget -->
<div
  *ngIf="!isChatStarted"
  id="jarvis-chat"
  class="jarvis-chat bottom-25 bg-white right-10 absolute z-[99999] h-[584px] w-[24rem] rounded-[20px] shadow-2xl"
>
  <div
    class="jarvis-header space-y-4 p-5 h-[40%] bg-gradient-to-b from-[#218DEB] to-[#7DC2FD] rounded-b-[30px] rounded-[20px]"
  >
    <div class="p-5 flex gap-2 items-center">
      <img
        src="/jarvis_logo.png"
        alt="Jarvis"
        class="jarvis-avatar w-10 h-10 rounded-full"
      />
      <div class="jarvis-title flex flex-col text-white">
        <strong>Jarvis</strong>
        <small>Reply in 10 seconds.</small>
      </div>
    </div>
    <div class="jarvis-header-lower">
      <h1 class="first text-white text-2xl">Let's start a conversation</h1>
      <h2 class="second text-white text-lg">
        Typically replies in 10 seconds.
      </h2>
    </div>
  </div>
  <div class="jarvis-body p-5 space-y-5">
    <div
      class="shadow-md rounded-3xl flex justify-between p-3 px-6 items-center tracking-tight cursor-pointer"
      (click)="startConversation()"
    >
      <div class="">
        <h5 class="text-lg font-semibold text-gray-700 tracking-tight">
          Start a Conversation
        </h5>
        <p class="text-xs tracking-tight text-gray-700">Send us a message</p>
      </div>
      <svg
        data-v-d83a6c8c=""
        id="Layer_1"
        data-name="Layer 1"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 684.98 684.98"
        width="40.909"
        height="40.909"
      >
        <defs data-v-d83a6c8c=""></defs>
        <circle
          data-v-d83a6c8c=""
          fill="#1F8CEB"
          cx="344.47"
          cy="342.04"
          r="334.98"
          style="isolation: isolate"
        ></circle>
        <path
          data-v-d83a6c8c=""
          fill="#1F8CEB"
          d="M415,240a11.35,11.35,0,1,0,11.35,11.35A11.35,11.35,0,0,0,415,240Z"
        ></path>
        <path
          data-v-d83a6c8c=""
          fill="#fff"
          d="M459.34,130.53H228.62c-69.22,0-115.36,46.15-115.36,115.36V384.33c0,69.21,46.14,115.36,115.36,115.36v49.14A23,23,0,0,0,264.38,568l102.67-68.29h92.29c69.22,0,115.36-46.15,115.36-115.36V245.89C574.7,176.68,528.56,130.53,459.34,130.53ZM277.16,414.69c-.21,2.73-.46,5.91-.65,9.58v0a6.85,6.85,0,0,1-4.27,6L226.8,448.39l0,0a6.93,6.93,0,0,1-2.58.5,6.82,6.82,0,0,1-6.81-6.82,6.58,6.58,0,0,1,.48-2.52l18.16-45.41c1-2.58,3.1-3.62,6.36-4.27l4.33,0h0c16.09.07,22.75.11,27.36,5.11C278.34,399.51,277.87,405.56,277.16,414.69ZM412.68,338.3v87a6.83,6.83,0,0,1-5.16,6.61L334.88,450.1h.06a6.83,6.83,0,0,1-1.7.21h0a6.79,6.79,0,0,1-6.79-6.79V393.77q-8.61,4.55-17.32,9h0l0,0h0a6.86,6.86,0,0,1-7.93-1.25l-36.32-36.32a6.86,6.86,0,0,1-2-4.83,6.77,6.77,0,0,1,.68-3c2.92-6,5.89-11.75,8.87-17.45H224.28a6.82,6.82,0,0,1-6.81-6.82,6.66,6.66,0,0,1,.2-1.65l18.16-72.64v0a6.79,6.79,0,0,1,6.59-5.11h86.95c44.21-51.07,93.67-75.08,149.43-72.64h0a6.8,6.8,0,0,1,6.47,6.33v0C489.82,252.5,459,300.05,412.68,338.3Z"
        ></path>
        <path
          data-v-d83a6c8c=""
          fill="#fff"
          d="M263.82,403.73c-1.06-.17-8.66-.21-16.8-.24l-10.54,26.36,26.68-10.64c.13-2,.28-3.84.41-5.52,0,.07,0,.14,0,.2l0-.24h0v0a46.56,46.56,0,0,0,.4-6.17C264,406.18,263.92,404.87,263.82,403.73Z"
        ></path>
        <path
          data-v-d83a6c8c=""
          fill="#fff"
          d="M415,276.35a25,25,0,1,1,25-25A25,25,0,0,1,415,276.35Z"
        ></path>
      </svg>
    </div>
    <div
      class="shadow-md rounded-3xl flex justify-between p-3 px-6 cursor-pointer items-center tracking-tight"
    >
      <div>
        <h1 class="text-lg font-semibold text-gray-700 tracking-tight">
          Continue Conversation
        </h1>
        <p class="text-xs tracking-tight text-gray-700">
          Pick up where you left off
        </p>
      </div>
      <img
        src="/telegram_img.jpeg"
        class="w-10 rounded-lg object-cover"
        alt=""
      />
    </div>
  </div>
</div>

<!-- Start Conversation Chat UI -->
<div
  *ngIf="isChatStarted"
  class="jarvis-chat-ui absolute bottom-25 right-10 z-[100000] bg-white rounded-[20px] w-[24rem] h-[584px] flex flex-col overflow-hidden"
>
  <div
    class="absolute overlay-animate top-10 w-full h-[160px] bg-gradient-to-b from-[#218DEB] to-[#7DC2FD] rounded-b-[30px] transition-transform duration-700 ease-in-out"
  ></div>

  <div
    class="bg-gradient-to-b from-[#218DEB] to-[#7DC2FD] relative text-white rounded-b-[30px] p-4 flex items-center justify-between"
  >
    <div class="flex gap-4">
      <div
        (click)="isChatStarted = false"
        style="
          background-image: url('https://widget.osam.one/dist/images/Chat/Back.svg');
        "
        class="self-center h-10 bg-center bg-no-repeat bg-auto cursor-pointer w-14 hover:bg-opacity-10 hover:rounded-sm"
      ></div>
      <div class="flex items-center gap-2">
        <img
          src="/jarvis_logo.png"
          class="w-10 h-10 rounded-full"
          alt="Jarvis"
        />
        <div>
          <div class="font-bold">Jarvis</div>
          <div class="text-sm">Reply in 10 seconds.</div>
        </div>
      </div>
    </div>
    <div
      class="text-white text-2xl cursor-pointer"
      (click)="isChatStarted = false"
    >
      √ó
    </div>
  </div>
  <div class="flex-1 p-2 justify-between flex flex-col">
    <div
      #messagesContainer
      class="hide-scrollbar flex flex-col space-y-4 h-[59vh] overflow-y-auto"
    >
      <div *ngFor="let msg of messages" class="chat-message">
        <div
          class="flex items-end"
          [ngClass]="{
            'justify-end': msg.sender === 'user',
            'justify-start': msg.sender === 'bot'
          }"
        >
          <div
            class="flex flex-col space-y-2 text-xs max-w-xs mx-2"
            [ngClass]="{
              'order-1 items-end': msg.sender === 'user',
              'order-2 items-start': msg.sender === 'bot'
            }"
          >
            <div>
              <ng-container>
                <!-- 1Ô∏è‚É£ Media Block Slides (Image Carousel Only) -->
                <div
                  *ngIf="msg.slides && msg.slides.length > 0"
                  class="flex space-x-2 overflow-x-auto max-w-[158px] p-1"
                >
                  <div
                    *ngFor="let slide of msg.slides"
                    class="flex-shrink-0 flex flex-col items-center space-y-1"
                  >
                    <img
                      [src]="slide.image"
                      class="max-w-[150px] rounded-lg border border-gray-300"
                      alt="Slide Image"
                    />
                    <span *ngIf="slide.title" class="text-gray-600 text-[10px]">
                      {{ slide.title }}
                    </span>
                  </div>
                </div>

                <!-- 2Ô∏è‚É£ Image -->
                <img
                  *ngIf="msg.type === 'image' && !msg.slides"
                  [src]="msg.fileUrl"
                  alt="Image message"
                  class="max-w-[200px] rounded-lg border border-gray-300"
                />

                <!-- 3Ô∏è‚É£ Video -->
                <video
                  *ngIf="msg.type === 'video'"
                  [src]="msg.fileUrl"
                  controls
                  class="max-w-[200px] rounded-lg border border-gray-300"
                ></video>

                <!-- 4Ô∏è‚É£ Audio -->
                <audio
                  *ngIf="msg.type === 'audio'"
                  [src]="msg.fileUrl"
                  controls
                  class="rounded-lg border border-gray-300 w-[200px]"
                ></audio>

                <!-- 7Ô∏è‚É£ Generic File / PDF Block -->
                <div
                  *ngIf="msg.type === 'file'"
                  class="flex flex-col items-center space-y-2 rounded-lg border border-gray-300 w-[200px] bg-gray-100 p-2"
                >
                  <!-- PDF Icon -->
                  <img
                    *ngIf="isPdf(msg.fileUrl)"
                    src="/PDF_file_icon.png"
                    alt="PDF File"
                    class="w-[50px] h-[50px] cursor-pointer"
                    (click)="openFile(msg.fileUrl)"
                  />

                  <!-- Generic File Icon -->
                  <img
                    *ngIf="!isPdf(msg.fileUrl)"
                    src="/PDF_file_icon.png"
                    alt="File"
                    class="w-[50px] h-[50px] cursor-pointer"
                    (click)="openFile(msg.fileUrl)"
                  />

                  <!-- File Name -->
                  <span
                    class="text-gray-700 text-xs break-all text-center px-1"
                  >
                    {{ msg.text || "Document" }}
                  </span>

                  <!-- Download Button -->
                  <a
                    [href]="msg.fileUrl || ''"
                    download
                    target="_blank"
                    class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs hover:bg-blue-700 transition"
                  >
                    üì• Download
                  </a>
                </div>

                <!-- 5Ô∏è‚É£ Text Message -->
                <span
                  *ngIf="!msg.type && !msg.quickReplies && !msg.slides"
                  class="px-4 py-2 rounded-lg inline-block"
                  [ngClass]="{
                    'bg-blue-600 text-white rounded-br-none':
                      msg.sender === 'user',
                    'bg-gray-300 text-gray-600 rounded-bl-none':
                      msg.sender === 'bot'
                  }"
                >
                  {{ msg.text }}
                </span>

                <!-- 6Ô∏è‚É£ Quick Replies -->
                <div
                  *ngIf="msg.quickReplies"
                  class="space-y-2 py-2 px-4 bg-gray-300 text-gray-600 rounded-lg inline-block"
                >
                  <div>{{ msg.text }}</div>
                  <div class="flex space-x-2 mt-2">
                    <button
                      class="bg-blue-600 rounded text-white cursor-pointer px-2 py-1"
                      *ngFor="let reply of msg.quickReplies"
                      (click)="handleQuickReply(reply)"
                    >
                      {{ reply }}
                    </button>
                  </div>
                </div>

                <div
                  *ngIf="msg.buttons?.length"
                  class="flex flex-wrap gap-2 mt-2"
                >
                  <button
                    *ngFor="let btn of msg.buttons"
                    class="px-3 py-1 bg-blue-500 w-full text-white rounded-lg text-xs hover:bg-blue-600"
                    (click)="onButtonClick(msg, btn)"
                  >
                    {{ btn.title }}
                  </button>
                </div>

                <!-- Show selected button message -->
                <div
                  *ngIf="msg.selectedButtonMessage"
                  class="mt-2 p-2 bg-gray-100 text-gray-700 rounded-lg border text-xs"
                >
                  {{ msg.selectedButtonMessage }}
                </div>
              </ng-container>
            </div>
          </div>

          <!-- Avatar -->
          <img
            [src]="
              msg.sender === 'user'
                ? 'https://images.unsplash.com/photo-1590031905470-a1a1feacbb0b'
                : 'https://images.unsplash.com/photo-1549078642-b2ba4bda0cdb'
            "
            alt="profile"
            class="w-6 h-6 rounded-full"
            [ngClass]="{
              'order-2': msg.sender === 'user',
              'order-1': msg.sender === 'bot'
            }"
          />
        </div>
      </div>
    </div>

    <div class="sm:mb-0">
      <div
        class="inline-flex items-center w-full my-1 justify-between px-2 bg-gray-100 rounded-3xl gap-1"
      >
        <img
          src="/Smiley.svg"
          class="w-6 h-6 cursor-pointer border-none"
          alt=""
          (click)="toggleEmojiPicker()"
        />
        <!-- Emoji Picker -->
        <div
          *ngIf="showEmojiPicker"
          class="absolute bottom-14 bg-[#FFFFFF] left-4 z-50 w-[300px] h-[250px] rounded-lg overflow-y-auto p-2"
        >
          <emoji-mart
            set="apple"
            (emojiSelect)="addEmoji($event)"
            [style]="{ width: '300px' }"
            class="w-[100%] flex flex-wrap"
          ></emoji-mart>
          <!-- <div class="absolute top-2 right-0 z-10 cursor-pointer" (click)="toggleEmojiPicker()">
            <svg
              data-v-6597d3d2=""
              xmlns="http://www.w3.org/2000/svg"
              width="16.413"
              height="17.413"
              stroke="#000"
              viewBox="0 0 16.413 17.413"
              class="h-4 w-4 mx-2"
            >
              <g
                data-v-6597d3d2=""
                id="line"
                transform="translate(0.587 1.061)"
              >
                <line
                  data-v-6597d3d2=""
                  id="Line_7"
                  data-name="Line 7"
                  x2="15"
                  y2="16"
                  transform="translate(0.12 -0.354)"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1"
                ></line>
                <line
                  data-v-6597d3d2=""
                  id="Line_8"
                  data-name="Line 8"
                  x1="15"
                  y2="16"
                  transform="translate(0.12 -0.354)"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1"
                ></line>
              </g>
            </svg>
          </div>
          <div class="flex flex-col">
            <span>Frequently Used</span>
            <div class="flex flex-wrap">
              <button class="font-[1.75rem]">üëç</button>
              <button>üëé</button>
              <button>üò≠</button>
              <button>üòï</button>
              <button>üòï</button>
              <button>üòä</button>
              <button>üòç</button>
            </div>
          </div> -->
        </div>

        <input
          [(ngModel)]="messageText"
          (keyup.enter)="sendMessage()"
          placeholder="Type your message"
          class="w-full text-sm bg-transparent border-none h-9 focus:outline-0 ring-transparent px-2"
        />

        <!-- Hidden File Input -->
        <input
          #fileInput
          type="file"
          multiple
          hidden
          (change)="handleFileInput($event)"
          accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.ppt,.pptx,.txt,.zip"
        />

        <!-- Trigger Button -->
        <div (click)="fileInput.click()" class="cursor-pointer h-6 w-6">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 25.794 24.42"
          >
            <g id="XMLID_221_" transform="translate(0 -8.794)">
              <path
                id="XMLID_222_"
                d="M2.4,30.814a8.216,8.216,0,0,0,11.607,0l10.07-10.07a5.862,5.862,0,0,0-8.29-8.29L6.549,21.694a3.517,3.517,0,1,0,4.974,4.974l6.085-6.085a1.172,1.172,0,1,0-1.658-1.658L9.865,25.01a1.172,1.172,0,1,1-1.658-1.658l9.241-9.241a3.517,3.517,0,0,1,4.974,4.974l-10.07,10.07a5.862,5.862,0,1,1-8.29-8.29L14.132,10.8a1.172,1.172,0,1,0-1.658-1.658L2.4,19.207a8.207,8.207,0,0,0,0,11.607Z"
                fill="#1F8CEB"
              ></path>
            </g>
          </svg>
        </div>

        <div class="w-6 h-6 cursor-pointer" (click)="startListening()">
          <svg
            id="mic-solid-svgrepo-com"
            xmlns="http://www.w3.org/2000/svg"
            width="16.448"
            height="24.672"
            viewBox="0 0 16.448 24.672"
            fill="#1F8CEB"
            class=""
            [attr.fill]="isListening ? '#60EFFF' : '#1F8CEB'"
          >
            <path
              id="Path_21"
              data-name="Path 21"
              d="M13.112,3A4.112,4.112,0,0,0,9,7.112V13.28a4.112,4.112,0,0,0,8.224,0V7.112A4.112,4.112,0,0,0,13.112,3Z"
              transform="translate(-4.888 -3)"
            ></path>
            <path
              id="Path_22"
              data-name="Path 22"
              d="M8.056,10.778a1.028,1.028,0,1,0-2.056,0,8.144,8.144,0,0,0,7.2,8.163v4.173H11.14a1.028,1.028,0,0,0,0,2.056h6.168a1.028,1.028,0,0,0,0-2.056H15.252V18.941a8.144,8.144,0,0,0,7.2-8.163,1.028,1.028,0,1,0-2.056,0,6.168,6.168,0,0,1-12.336,0Z"
              transform="translate(-6 -0.498)"
            ></path>
          </svg>
        </div>

        <!-- Send Button -->
        <div (click)="sendMessage()" class="cursor-pointer w-6 h-6">
          <!-- <span class="font-bold">Send</span> -->
          <!-- <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
              class="h-6 w-6 ml-2 transform rotate-90"
            >
              <path
                d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"
              ></path>
            </svg> -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            width="24"
            height="24"
            viewBox="0 0 32.008 32.008"
          >
            <defs>
              <clipPath id="clip-path">
                <path
                  id="Path_40"
                  data-name="Path 40"
                  d="M28.9,28.9H60.91V60.91H28.9Zm0,0"
                  transform="translate(0 0)"
                  fill="#1F8CEB"
                ></path>
              </clipPath>
            </defs>
            <g
              id="Untitled_design_14_"
              data-name="Untitled design (14)"
              transform="translate(-28.902 -28.902)"
              clip-path="url(#clip-path)"
            >
              <path
                id="Path_39"
                data-name="Path 39"
                d="M44.906,28.9q-.392,0-.785.019t-.784.058q-.391.038-.779.1t-.774.134q-.385.076-.767.172t-.757.21q-.376.114-.746.246t-.733.283q-.363.15-.718.318t-.7.353q-.346.186-.683.387t-.664.42q-.327.218-.642.452t-.619.483q-.3.249-.595.513t-.569.542q-.278.278-.542.569t-.513.595q-.249.3-.483.619t-.452.642q-.218.326-.42.664t-.387.683q-.185.346-.353.7t-.318.718q-.151.363-.283.733t-.246.746q-.114.376-.21.757t-.172.767q-.077.385-.134.774t-.1.779q-.038.391-.058.784t-.019.785q0,.393.019.786t.058.783q.038.391.1.78t.134.774q.076.385.172.766t.21.757q.114.376.246.746t.283.733q.15.363.318.719t.353.7q.186.346.387.683t.42.664q.218.327.452.642t.483.619q.249.3.513.595t.542.569q.278.278.569.542t.595.513q.3.249.619.483t.642.452q.326.218.664.42t.683.387q.346.186.7.354t.718.318q.363.151.733.283t.746.246q.376.114.757.209t.767.172q.385.077.774.134t.779.1q.391.038.784.058t.785.019q.393,0,.786-.019t.783-.058q.391-.038.78-.1t.774-.134q.385-.077.766-.172t.757-.209q.376-.114.746-.246t.733-.283q.363-.15.719-.318t.7-.354q.346-.185.683-.387t.664-.42q.327-.219.642-.452t.619-.483q.3-.249.595-.513t.569-.542q.278-.278.542-.569t.513-.595q.249-.3.483-.619t.452-.642q.218-.327.42-.664t.387-.683q.186-.346.354-.7t.318-.719q.151-.363.283-.733t.246-.746q.114-.376.209-.757t.172-.766q.077-.385.134-.774t.1-.78q.038-.391.058-.783t.019-.786q0-.392-.019-.785t-.058-.783q-.039-.391-.1-.779t-.134-.774q-.077-.385-.172-.766t-.21-.757q-.114-.376-.247-.746t-.283-.733q-.15-.363-.319-.718t-.353-.7q-.185-.346-.387-.683t-.421-.664q-.218-.326-.452-.642t-.484-.619q-.249-.3-.513-.595t-.542-.569q-.278-.278-.569-.542t-.595-.513q-.3-.249-.619-.484T53.8,31.6q-.327-.219-.664-.421t-.683-.387q-.346-.186-.7-.354t-.718-.318q-.363-.15-.733-.283t-.746-.247q-.376-.114-.757-.21t-.766-.172q-.385-.077-.774-.134t-.78-.1q-.391-.038-.783-.058T44.906,28.9Zm8.664,9.186-7.8,16.441a1.356,1.356,0,0,1-.5.575,1.365,1.365,0,0,1-.734.214H44.5a1.375,1.375,0,0,1-1.238-.832l-2.016-4.726a.318.318,0,0,1-.026-.091.313.313,0,0,1,.034-.185.3.3,0,0,1,.056-.076l3.115-3.115a.666.666,0,0,0,.08-.1.636.636,0,0,0,.059-.111.633.633,0,0,0,.037-.371.612.612,0,0,0-.036-.12.638.638,0,0,0-.139-.208.636.636,0,0,0-.208-.139.647.647,0,0,0-.121-.037.664.664,0,0,0-.125-.012.646.646,0,0,0-.356.108.649.649,0,0,0-.1.08L40.4,48.5a.321.321,0,0,1-.076.056.315.315,0,0,1-.09.031.3.3,0,0,1-.1,0,.3.3,0,0,1-.091-.026L35.325,46.55a1.373,1.373,0,0,1-.832-1.24,1.376,1.376,0,0,1,.208-.75,1.37,1.37,0,0,1,.582-.517l16.441-7.8a1.391,1.391,0,0,1,.406-.118,1.388,1.388,0,0,1,.422.009,1.371,1.371,0,0,1,.205.053,1.389,1.389,0,0,1,.374.2,1.392,1.392,0,0,1,.3.3,1.406,1.406,0,0,1,.112.18,1.387,1.387,0,0,1,.083.195,1.384,1.384,0,0,1,.062.627,1.368,1.368,0,0,1-.043.207A1.354,1.354,0,0,1,53.57,38.089Zm0,0"
                transform="translate(0 0)"
                fill="#1F8CEB"
              ></path>
            </g>
          </svg>
        </div>
      </div>
    </div>
  </div>
</div>
