<!-- Jarvis Chat Widget -->
<div
  *ngIf="!isChatStarted"
  id="jarvis-chat"
  class="jarvis-chat bottom-25 bg-white right-10 absolute z-[99999] h-[584px] w-[24rem] rounded-[20px] shadow-2xl"
>
  <div
    class="jarvis-header space-y-4 p-5 h-[40%] bg-gradient-to-b from-[#218DEB] to-[#7DC2FD] rounded-b-[30px] rounded-[20px]"
  >
    <div class="p-5 flex gap-2 items-center">
      <img
        src="/jarvis_logo.png"
        alt="Jarvis"
        class="jarvis-avatar w-10 h-10 rounded-full"
      />
      <div class="jarvis-title flex flex-col text-white">
        <strong>Jarvis</strong>
        <small>Reply in 10 seconds.</small>
      </div>
    </div>
    <div class="jarvis-header-lower">
      <h1 class="first text-white text-2xl">Let's start a conversation</h1>
      <h2 class="second text-white text-lg">
        Typically replies in 10 seconds.
      </h2>
    </div>
  </div>
  <div class="jarvis-body p-5 space-y-5">
    <div
      class="shadow-md rounded-3xl flex justify-between p-3 px-6 items-center tracking-tight cursor-pointer"
      (click)="startConversation()"
    >
      <div class="">
        <h5 class="text-lg font-semibold text-gray-700 tracking-tight">
          Start a Conversation
        </h5>
        <p class="text-xs tracking-tight text-gray-700">Send us a message</p>
      </div>
      <svg
        data-v-d83a6c8c=""
        id="Layer_1"
        data-name="Layer 1"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 684.98 684.98"
        width="40.909"
        height="40.909"
      >
        <defs data-v-d83a6c8c=""></defs>
        <circle
          data-v-d83a6c8c=""
          fill="#1F8CEB"
          cx="344.47"
          cy="342.04"
          r="334.98"
          style="isolation: isolate"
        ></circle>
        <path
          data-v-d83a6c8c=""
          fill="#1F8CEB"
          d="M415,240a11.35,11.35,0,1,0,11.35,11.35A11.35,11.35,0,0,0,415,240Z"
        ></path>
        <path
          data-v-d83a6c8c=""
          fill="#fff"
          d="M459.34,130.53H228.62c-69.22,0-115.36,46.15-115.36,115.36V384.33c0,69.21,46.14,115.36,115.36,115.36v49.14A23,23,0,0,0,264.38,568l102.67-68.29h92.29c69.22,0,115.36-46.15,115.36-115.36V245.89C574.7,176.68,528.56,130.53,459.34,130.53ZM277.16,414.69c-.21,2.73-.46,5.91-.65,9.58v0a6.85,6.85,0,0,1-4.27,6L226.8,448.39l0,0a6.93,6.93,0,0,1-2.58.5,6.82,6.82,0,0,1-6.81-6.82,6.58,6.58,0,0,1,.48-2.52l18.16-45.41c1-2.58,3.1-3.62,6.36-4.27l4.33,0h0c16.09.07,22.75.11,27.36,5.11C278.34,399.51,277.87,405.56,277.16,414.69ZM412.68,338.3v87a6.83,6.83,0,0,1-5.16,6.61L334.88,450.1h.06a6.83,6.83,0,0,1-1.7.21h0a6.79,6.79,0,0,1-6.79-6.79V393.77q-8.61,4.55-17.32,9h0l0,0h0a6.86,6.86,0,0,1-7.93-1.25l-36.32-36.32a6.86,6.86,0,0,1-2-4.83,6.77,6.77,0,0,1,.68-3c2.92-6,5.89-11.75,8.87-17.45H224.28a6.82,6.82,0,0,1-6.81-6.82,6.66,6.66,0,0,1,.2-1.65l18.16-72.64v0a6.79,6.79,0,0,1,6.59-5.11h86.95c44.21-51.07,93.67-75.08,149.43-72.64h0a6.8,6.8,0,0,1,6.47,6.33v0C489.82,252.5,459,300.05,412.68,338.3Z"
        ></path>
        <path
          data-v-d83a6c8c=""
          fill="#fff"
          d="M263.82,403.73c-1.06-.17-8.66-.21-16.8-.24l-10.54,26.36,26.68-10.64c.13-2,.28-3.84.41-5.52,0,.07,0,.14,0,.2l0-.24h0v0a46.56,46.56,0,0,0,.4-6.17C264,406.18,263.92,404.87,263.82,403.73Z"
        ></path>
        <path
          data-v-d83a6c8c=""
          fill="#fff"
          d="M415,276.35a25,25,0,1,1,25-25A25,25,0,0,1,415,276.35Z"
        ></path>
      </svg>
    </div>
    <div
      class="shadow-md rounded-3xl flex justify-between p-3 px-6 cursor-pointer items-center tracking-tight"
    >
      <div>
        <h1 class="text-lg font-semibold text-gray-700 tracking-tight">
          Continue Conversation
        </h1>
        <p class="text-xs tracking-tight text-gray-700">
          Pick up where you left off
        </p>
      </div>
      <img
        src="/telegram_img.jpeg"
        class="w-10 rounded-lg object-cover"
        alt=""
      />
    </div>
  </div>
</div>

<!-- Start Conversation Chat UI -->
<div
  *ngIf="isChatStarted"
  class="jarvis-chat-ui absolute bottom-25 right-10 z-[100000] bg-white rounded-[20px] w-[24rem] h-[584px] flex flex-col overflow-hidden"
>
  <div
    class="absolute overlay-animate top-10 w-full h-[160px] bg-[#52A6F4] rounded-b-[30px] transition-transform duration-700 ease-in-out"
  ></div>

  <div
    class="bg-gradient-to-b from-[#218DEB] to-[#7DC2FD] relative text-white rounded-b-[30px] p-4 flex items-center justify-between z-10"
  >
    <div class="flex items-center gap-2">
      <img src="/jarvis_logo.png" class="w-10 h-10 rounded-full" alt="Jarvis" />
      <div>
        <div class="font-bold">Jarvis</div>
        <div class="text-sm">Reply in 10 seconds.</div>
      </div>
    </div>
    <div
      class="text-white text-2xl cursor-pointer"
      (click)="isChatStarted = false"
    >
      ×
    </div>
  </div>
  <div class="flex-1 p-2 justify-between flex flex-col">
    <div
      #messagesContainer
      class="hide-scrollbar flex flex-col space-y-4 h-[55vh] overflow-y-auto"
    >
      <div *ngFor="let msg of messages" class="chat-message">
        <div
          class="flex items-end"
          [ngClass]="{
            'justify-end': msg.sender === 'user',
            'justify-start': msg.sender === 'bot'
          }"
        >
          <div
            class="flex flex-col space-y-2 text-xs max-w-xs mx-2"
            [ngClass]="{
              'order-1 items-end': msg.sender === 'user',
              'order-2 items-start': msg.sender === 'bot'
            }"
          >
            <div>
              <ng-container>
                <!-- 1️⃣ Media Block Slides (Image Carousel Only) -->
                <div
                  *ngIf="msg.slides && msg.slides.length > 0"
                  class="flex space-x-2 overflow-x-auto max-w-[158px] p-1"
                >
                  <div
                    *ngFor="let slide of msg.slides"
                    class="flex-shrink-0 flex flex-col items-center space-y-1"
                  >
                    <img
                      [src]="slide.image"
                      class="max-w-[150px] rounded-lg border border-gray-300"
                      alt="Slide Image"
                    />
                    <span *ngIf="slide.title" class="text-gray-600 text-[10px]">
                      {{ slide.title }}
                    </span>
                  </div>
                </div>

                <!-- 2️⃣ Image -->
                <img
                  *ngIf="msg.type === 'image' && !msg.slides"
                  [src]="msg.fileUrl"
                  alt="Image message"
                  class="max-w-[200px] rounded-lg border border-gray-300"
                />

                <!-- 3️⃣ Video -->
                <video
                  *ngIf="msg.type === 'video'"
                  [src]="msg.fileUrl"
                  controls
                  class="max-w-[200px] rounded-lg border border-gray-300"
                ></video>

                <!-- 4️⃣ Audio -->
                <audio
                  *ngIf="msg.type === 'audio'"
                  [src]="msg.fileUrl"
                  controls
                  class="rounded-lg border border-gray-300 w-[200px]"
                ></audio>

                <!-- 7️⃣ Generic File / PDF Block -->
                <div
                  *ngIf="msg.type === 'file'"
                  class="flex flex-col items-center space-y-2 rounded-lg border border-gray-300 w-[200px] bg-gray-100 p-2"
                >
                  <!-- PDF Icon -->
                  <img
                    *ngIf="isPdf(msg.fileUrl)"
                    src="/PDF_file_icon.png"
                    alt="PDF File"
                    class="w-[50px] h-[50px] cursor-pointer"
                    (click)="openFile(msg.fileUrl)"
                  />

                  <!-- Generic File Icon -->
                  <img
                    *ngIf="!isPdf(msg.fileUrl)"
                    src="/PDF_file_icon.png"
                    alt="File"
                    class="w-[50px] h-[50px] cursor-pointer"
                    (click)="openFile(msg.fileUrl)"
                  />

                  <!-- File Name -->
                  <span
                    class="text-gray-700 text-xs break-all text-center px-1"
                  >
                    {{ msg.text || "Document" }}
                  </span>

                  <!-- Download Button -->
                  <a
                    [href]="msg.fileUrl || ''"
                    download
                    target="_blank"
                    class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs hover:bg-blue-700 transition"
                  >
                    📥 Download
                  </a>
                </div>

                <!-- 5️⃣ Text Message -->
                <span
                  *ngIf="!msg.type && !msg.quickReplies && !msg.slides"
                  class="px-4 py-2 rounded-lg inline-block"
                  [ngClass]="{
                    'bg-blue-600 text-white rounded-br-none':
                      msg.sender === 'user',
                    'bg-gray-300 text-gray-600 rounded-bl-none':
                      msg.sender === 'bot'
                  }"
                >
                  {{ msg.text }}
                </span>

                <!-- 6️⃣ Quick Replies -->
                <div
                  *ngIf="msg.quickReplies"
                  class="space-y-2 py-2 px-4 bg-gray-300 text-gray-600 rounded-lg inline-block"
                >
                  <div>{{ msg.text }}</div>
                  <div class="flex space-x-2 mt-2">
                    <button
                      class="bg-blue-600 rounded text-white cursor-pointer px-2 py-1"
                      *ngFor="let reply of msg.quickReplies"
                      (click)="handleQuickReply(reply)"
                    >
                      {{ reply }}
                    </button>
                  </div>
                </div>

                <div
                  *ngIf="msg.buttons?.length"
                  class="flex flex-wrap gap-2 mt-2"
                >
                  <button
                    *ngFor="let btn of msg.buttons"
                    class="px-3 py-1 bg-blue-500 w-full text-white rounded-lg text-xs hover:bg-blue-600"
                    (click)="onButtonClick(msg, btn)"
                  >
                    {{ btn.title }}
                  </button>
                </div>

                <!-- Show selected button message -->
                <div
                  *ngIf="msg.selectedButtonMessage"
                  class="mt-2 p-2 bg-gray-100 text-gray-700 rounded-lg border text-xs"
                >
                  {{ msg.selectedButtonMessage }}
                </div>
              </ng-container>
            </div>
          </div>

          <!-- Avatar -->
          <img
            [src]="
              msg.sender === 'user'
                ? 'https://images.unsplash.com/photo-1590031905470-a1a1feacbb0b'
                : 'https://images.unsplash.com/photo-1549078642-b2ba4bda0cdb'
            "
            alt="profile"
            class="w-6 h-6 rounded-full"
            [ngClass]="{
              'order-2': msg.sender === 'user',
              'order-1': msg.sender === 'bot'
            }"
          />
        </div>
      </div>
    </div>

    <div class="border-t-2 border-gray-200 pt-2 sm:mb-0">
      <div class="relative flex">
        <span class="absolute inset-y-0 flex items-center">
          <button
            type="button"
            class="inline-flex items-center justify-center rounded-full h-12 w-12 transition duration-500 ease-in-out text-gray-500 hover:bg-gray-300 focus:outline-none"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              class="h-6 w-6 text-gray-600"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
              ></path>
            </svg>
          </button>
        </span>
        <input
          [(ngModel)]="messageText"
          (keyup.enter)="sendMessage()"
          placeholder="Write your message!"
          class="w-full focus:outline-none focus:placeholder-gray-400 text-gray-600 placeholder-gray-600 pl-12 bg-gray-200 rounded-md py-3"
        />
        <div class="absolute right-0 items-center inset-y-0 hidden sm:flex">
          <!-- Trigger Button -->
          <button
            type="button"
            (click)="fileInput.click()"
            class="inline-flex items-center justify-center rounded-full h-10 w-10 transition duration-500 ease-in-out text-gray-500 hover:bg-gray-300 focus:outline-none"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              class="h-6 w-6 text-gray-600"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"
              ></path>
            </svg>
          </button>

          <!-- Hidden File Input -->
          <input
            #fileInput
            type="file"
            multiple
            hidden
            (change)="handleFileInput($event)"
            accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.ppt,.pptx,.txt,.zip"
          />

          <!-- Send Button -->
          <button
            type="button"
            (click)="sendMessage()"
            class="inline-flex items-center justify-center rounded-lg px-4 py-3 transition duration-500 ease-in-out text-white bg-blue-500 hover:bg-blue-400 focus:outline-none"
          >
            <span class="font-bold">Send</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
              class="h-6 w-6 ml-2 transform rotate-90"
            >
              <path
                d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
