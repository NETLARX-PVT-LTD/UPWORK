<!-- Main Container -->
<div class="manage-media-blocks-container h-full bg-gray-50">
  
  <!-- Header Section -->
  <div class="header-section bg-white border-b border-gray-200 p-6">
    <div class="flex justify-between items-center mb-4">
      <div class="flex items-center gap-3">
        <mat-icon class="text-red-500 text-2xl">play_circle_outline</mat-icon>
        <h1 class="text-2xl font-semibold text-gray-800">Manage Media Blocks</h1>
        <div class="flex items-center gap-2 ml-4">
          <span class="text-sm text-gray-600">Bot 2</span>
          <mat-icon class="text-gray-400 text-lg">expand_more</mat-icon>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <div class="relative">
          <input type="text" 
                 placeholder="Search..." 
                 class="px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <mat-icon class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
        </div>
        <button mat-flat-button 
                class="!bg-blue-500 hover:!bg-blue-600 !text-white !rounded-lg px-6 py-2 font-medium"
                (click)="createNewMediaBlock()">
          Create Media Block
        </button>
      </div>
    </div>
    
    <!-- Tutorial Link -->
    <div class="flex items-center gap-2">
      <mat-icon class="text-red-500 text-lg">play_circle_outline</mat-icon>
      <span class="text-sm text-red-500 font-medium cursor-pointer hover:underline">Tutorial</span>
    </div>
  </div>

  <!-- Media Blocks Grid -->
  <div class="media-blocks-grid p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      
      <!-- Media Block Card -->
      <div *ngFor="let media of availableMedia" 
           class="media-block-card bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200">
        
        <!-- Card Header -->
        <div class="card-header p-4 border-b border-gray-100">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-semibold text-gray-800 text-base truncate">{{ media.name }}</h3>
            <button mat-icon-button 
                    [matMenuTriggerFor]="mediaMenu" 
                    class="text-gray-400 hover:text-gray-600">
              <mat-icon>more_vert</mat-icon>
            </button>
            
            <!-- Context Menu -->
            <mat-menu #mediaMenu="matMenu">
              <button mat-menu-item (click)="selectMediaForEditing(media)">
                <mat-icon>edit</mat-icon>
                <span>Edit</span>
              </button>
              <button mat-menu-item (click)="duplicateMediaBlock(media)">
                <mat-icon>content_copy</mat-icon>
                <span>Duplicate</span>
              </button>
              <button mat-menu-item (click)="deleteMediaBlock(media.id)" class="text-red-600">
                <mat-icon>delete</mat-icon>
                <span>Delete</span>
              </button>
            </mat-menu>
          </div>
          
          <div class="text-xs text-gray-500 mb-3">{{ getFormattedDate(media.createdAt) }}</div>
          
          <!-- Media Type Badge -->
          <div class="flex items-center gap-2">
            <span class="px-2 py-1 rounded-full text-xs font-medium text-white" 
                  [ngClass]="getMediaTypeBadgeClass(media.type)">
              {{ getMediaTypeDisplayName(media.type) }}
            </span>
          </div>
        </div>

        <!-- Card Content Preview -->
        <div class="card-content p-4">
          <!-- Text Content Preview -->
          <div *ngIf="media.type === 'text' && media.content" 
               class="text-preview mb-3">
            <p class="text-sm text-gray-600 line-clamp-3">{{ media.content }}</p>
          </div>
          
          <!-- Image Preview -->
          <div *ngIf="media.type === 'image' && media.url" 
               class="image-preview mb-3">
            <img [src]="media.url" 
                 alt="Media preview" 
                 class="w-full h-24 object-cover rounded-md">
          </div>
          
          <!-- Image Slider Preview -->
          <div *ngIf="media.type === 'Image Slider' && media.slides && media.slides.length > 0" 
               class="slider-preview mb-3">
            <img [src]="media.slides[0].image" 
                 alt="Slide preview" 
                 class="w-full h-24 object-cover rounded-md">
            <p class="text-xs text-gray-600 mt-1 truncate">{{ media.slides[0].title }}</p>
          </div>
          
          <!-- Video Preview -->
          <div *ngIf="media.type === 'video'" 
               class="video-preview mb-3 bg-gray-900 rounded-md h-24 flex items-center justify-center">
            <mat-icon class="text-white text-3xl">play_circle_outline</mat-icon>
          </div>
          
          <!-- Audio Preview -->
          <div *ngIf="media.type === 'audio'" 
               class="audio-preview mb-3 bg-gray-100 rounded-md h-24 flex items-center justify-center">
            <mat-icon class="text-gray-500 text-3xl">volume_up</mat-icon>
          </div>
          
          <!-- File Preview -->
          <div *ngIf="media.type === 'file'" 
               class="file-preview mb-3 bg-gray-100 rounded-md h-24 flex items-center justify-center">
            <mat-icon class="text-gray-500 text-3xl">attachment</mat-icon>
          </div>

          <!-- Buttons Preview -->
          <div *ngIf="media.buttons && media.buttons.length > 0" 
               class="buttons-section">
            <div class="flex items-center gap-1 mb-2">
              <span class="text-xs font-medium text-gray-600">Buttons:</span>
              <div class="flex gap-1">
                <span *ngFor="let tag of getButtonTypeTags(media.buttons)"
                      class="px-2 py-0.5 bg-gray-200 text-gray-700 rounded-full text-xs">
                  {{ tag }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Card Actions -->
        <div class="card-actions flex justify-between items-center p-3 bg-gray-50 rounded-b-lg">
          <div class="flex gap-2">
            <button mat-icon-button 
                    class="text-blue-500 hover:bg-blue-50"
                    matTooltip="Edit"
                    (click)="selectMediaForEditing(media)">
              <mat-icon class="text-lg">edit</mat-icon>
            </button>
            <button mat-icon-button 
                    class="text-gray-500 hover:bg-gray-100"
                    matTooltip="Duplicate"
                    (click)="duplicateMediaBlock(media)">
              <mat-icon class="text-lg">content_copy</mat-icon>
            </button>
            <button mat-icon-button 
                    class="text-gray-500 hover:bg-gray-100"
                    matTooltip="More options">
              <mat-icon class="text-lg">more_horiz</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="availableMedia.length === 0" 
         class="empty-state text-center py-16">
      <mat-icon class="text-gray-300 text-6xl mb-4">folder_open</mat-icon>
      <h3 class="text-xl font-medium text-gray-600 mb-2">No Media Blocks Yet</h3>
      <p class="text-gray-500 mb-6">Create your first media block to get started</p>
      <button mat-flat-button 
              class="!bg-blue-500 hover:!bg-blue-600 !text-white !rounded-lg px-6 py-2"
              (click)="createNewMediaBlock()">
        Create Media Block
      </button>
    </div>
  </div>
</div>

<!-- Right Sidebar for Editing -->
<div class="edit-sidebar fixed right-0 top-0 h-full w-96 bg-white shadow-lg transform transition-transform duration-300 z-50"
     [class.translate-x-full]="!showEditSidebar"
     *ngIf="selectedMedia">
  
  <div class="sidebar-content h-full overflow-y-auto">
    
    <!-- Sidebar Header -->
    <div class="sidebar-header flex justify-between items-center p-5 border-b border-gray-200"
         *ngIf="!showNewMediaForm && !showButtonTypeCard && !showCommonIntegrationCard">
      <h4 class="text-lg font-semibold text-gray-800">Media Block</h4>
      <button mat-icon-button (click)="closeSidebar()" class="text-gray-500 hover:text-gray-700">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="sidebar-body p-5">
      <p class="text-sm text-gray-600 mb-6"
         *ngIf="!showNewMediaForm && !showButtonTypeCard && !showCommonIntegrationCard">
        Define the content that your chatbot will deliver, whether it's a text message, an image, a video, or any other type of media.
      </p>

      <!-- Create/Edit Media Form -->
      <div class="define-media-config" *ngIf="showNewMediaForm">
        
        <!-- Media Name and Save Button -->
        <div class="flex items-center gap-3 mb-6">
          <input type="text" 
                 [(ngModel)]="selectedMedia.name"
                 placeholder="Media Block Name"
                 class="px-4 py-2 border rounded-md text-base font-medium text-gray-800 flex-grow focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
          
          <button mat-flat-button
                  class="!bg-blue-500 hover:!bg-blue-600 !text-white h-11 px-6 !rounded-lg font-medium"
                  (click)="saveMedia()">
            Save
          </button>
          
          <button mat-icon-button (click)="closeSidebar()" class="text-gray-500 hover:text-gray-700">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Media Type Toggle -->
        <mat-button-toggle-group name="mediaType" 
                                 [(ngModel)]="selectedMedia.type"
                                 (ngModelChange)="onMediaTypeChange($event)" 
                                 class="media-type-toggle w-full mb-6">
          <mat-button-toggle value="text" class="media-toggle-button">TEXT MESSAGE</mat-button-toggle>
          <mat-button-toggle value="Image Slider" class="media-toggle-button">IMAGE SLIDER</mat-button-toggle>
          <mat-button-toggle value="image" class="media-toggle-button">IMAGE</mat-button-toggle>
          <mat-button-toggle value="video" class="media-toggle-button">VIDEO</mat-button-toggle>
          <mat-button-toggle value="audio" class="media-toggle-button">AUDIO</mat-button-toggle>
          <mat-button-toggle value="file" class="media-toggle-button">FILE</mat-button-toggle>
        </mat-button-toggle-group>

        <!-- Phone Frame Container -->
        <div class="phone-frame-container flex justify-center mb-6">
          <div class="relative bg-black rounded-3xl p-3 shadow-2xl" style="width: 280px; height: 500px;">
            <div class="bg-white rounded-2xl h-full flex flex-col relative overflow-hidden">
              
              <!-- Phone Status Bar -->
              <div class="flex justify-between items-center px-4 py-2 text-xs font-medium text-black bg-white">
                <span>9:41</span>
                <div class="flex items-center gap-1">
                  <!-- Status icons -->
                </div>
              </div>

              <!-- Phone Content Area -->
              <div class="flex-1 px-4 pb-8 flex flex-col justify-center bg-gray-100">
                <div class="bg-white rounded-2xl p-4 max-w-[85%] self-start">
                  
                  <!-- Text Content -->
                  <div *ngIf="selectedMedia.type === 'text'">
                    <mat-form-field appearance="outline" class="w-full">
                      <input matInput 
                             [(ngModel)]="selectedMedia.content"
                             placeholder="Type message you want to send..." 
                             class="text-sm text-gray-700" />
                      <mat-icon matSuffix class="text-gray-500">emoji_emotions</mat-icon>
                    </mat-form-field>
                  </div>

                  <!-- Image Upload -->
                  <div *ngIf="selectedMedia.type === 'image'" class="image-upload-container">
                    <div class="image-display-area relative bg-gray-200 rounded-lg flex flex-col items-center justify-center h-40 mb-3 border-2 border-dashed border-gray-300 overflow-hidden">
                      
                      <!-- Upload Prompt -->
                      <div class="upload-content text-center cursor-pointer p-4 w-full h-full flex items-center justify-center"
                           [class.hidden]="selectedMedia.url" 
                           (click)="openUploadModal('image')">
                        <div class="flex flex-col items-center justify-center">
                          <div class="upload-icon mb-2">
                            <div class="w-8 h-8 mx-auto bg-blue-500 rounded-full flex items-center justify-center">
                              <mat-icon class="text-white text-lg">image</mat-icon>
                            </div>
                          </div>
                          <p class="text-gray-600 text-sm font-medium mb-1">Drag your image here or click</p>
                          <p class="text-gray-600 text-sm font-medium">to upload</p>
                        </div>
                      </div>

                      <!-- Image Display -->
                      <div class="image-display w-full h-full" *ngIf="selectedMedia.url">
                        <img [src]="selectedMedia.url" 
                             alt="Image Preview" 
                             class="w-full h-full object-cover rounded-lg">
                        <button class="absolute top-2 right-2 w-6 h-6 rounded-lg flex items-center justify-center bg-red-500 bg-opacity-80 text-white hover:bg-opacity-100 transition-colors shadow-md z-20"
                                (click)="removeMedia()">
                          <mat-icon class="text-xs">delete</mat-icon>
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Video Upload -->
                  <div *ngIf="selectedMedia.type === 'video'" class="video-upload-container">
                    <div class="relative bg-gray-900 rounded-lg overflow-hidden mb-4 h-48">
                      
                      <!-- Default Video Display -->
                      <div *ngIf="!selectedMedia.url" class="w-full h-full flex items-center justify-center">
                        <div class="w-16 h-16 bg-white bg-opacity-90 rounded-full flex items-center justify-center">
                          <mat-icon class="text-gray-800 text-2xl">play_arrow</mat-icon>
                        </div>
                      </div>

                      <!-- Video Display -->
                      <div *ngIf="selectedMedia.url" class="relative w-full h-full">
                        <video [src]="selectedMedia.url" controls class="w-full h-full object-cover"></video>
                        <button class="absolute top-2 right-2 w-6 h-6 rounded-lg flex items-center justify-center bg-red-500 bg-opacity-80 text-white hover:bg-opacity-100 transition-colors shadow-md z-20"
                                (click)="removeVideoMedia()">
                          <mat-icon class="text-xs">delete</mat-icon>
                        </button>
                      </div>
                    </div>

                    <button class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-6 rounded-lg flex items-center justify-center gap-3 transition-colors"
                            (click)="openUploadModal('video')">
                      <span class="text-xl">+</span>
                      <span>Upload Video</span>
                    </button>
                  </div>

                  <!-- Audio Upload -->
                  <div *ngIf="selectedMedia.type === 'audio'" class="audio-upload-container">
                    <div class="relative bg-white rounded-lg overflow-hidden mb-4 h-32">
                      
                      <!-- Audio Player -->
                      <div *ngIf="selectedMedia.url" class="w-full h-full flex items-center justify-center p-4">
                        <audio controls [src]="selectedMedia.url" class="w-full max-w-full">
                          Your browser does not support the audio element.
                        </audio>
                        <button class="absolute top-2 right-2 w-6 h-6 rounded-lg flex items-center justify-center bg-red-500 bg-opacity-80 text-white hover:bg-opacity-100 transition-colors shadow-md z-20"
                                (click)="removeAudioMedia()">
                          <mat-icon class="text-xs">delete</mat-icon>
                        </button>
                      </div>
                      
                      <!-- Default Audio Display -->
                      <div *ngIf="!selectedMedia.url" class="w-full h-full flex items-center justify-center bg-gray-100">
                        <div class="flex flex-col items-center text-gray-500">
                          <mat-icon class="text-3xl mb-2">volume_up</mat-icon>
                          <span class="text-sm">No audio file</span>
                        </div>
                      </div>
                    </div>

                    <button class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-6 rounded-lg flex items-center justify-center gap-3 transition-colors"
                            (click)="triggerAudioUpload()">
                      <span class="text-xl">+</span>
                      <span>Upload Audio</span>
                    </button>
                  </div>

                  <!-- File Upload -->
                  <div *ngIf="selectedMedia.type === 'file'" class="file-upload-container">
                    <div *ngIf="!selectedMedia.url" class="w-full h-48 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 mb-4 p-4">
                      <mat-icon class="text-gray-400 text-4xl mb-2">cloud_upload</mat-icon>
                      <span class="text-sm text-gray-500 italic">Please Upload File</span>
                      <button mat-flat-button class="!bg-blue-500 !text-white mt-4" (click)="triggerFileUpload()">
                        Upload File
                      </button>
                    </div>

                    <div *ngIf="selectedMedia.url" class="w-full h-24 flex items-center justify-center border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 mb-4 p-4 relative">
                      <div class="flex items-center gap-2">
                        <mat-icon class="text-gray-400 text-2xl">description</mat-icon>
                        <span class="text-base text-gray-700">{{ uploadedFileName || 'uploaded-file.pdf' }}</span>
                      </div>
                      <button mat-icon-button (click)="removeFile()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-900">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </div>

                  <!-- Image Slider -->
                  <div *ngIf="selectedMedia.type === 'Image Slider'" class="image-slider-container">
                    <div class="slider-controls absolute top-16 right-8 flex space-x-2 z-10">
                      <button *ngIf="selectedMedia.slides && selectedMedia.slides.length > 1"
                              class="w-6 h-6 rounded-lg flex items-center justify-center bg-red-500 text-white hover:bg-red-600 transition-colors shadow-md"
                              (click)="removeCurrentSlide()">
                        <mat-icon class="text-xs">close</mat-icon>
                      </button>
                    </div>

                    <div class="slider-content" *ngIf="selectedMedia.slides && selectedMedia.slides.length > 0">
                      <div class="current-slide-content" [@slideAnimation]="currentSlideIndex">
                        <div class="relative flex items-center">
                          
                          <!-- Left Navigation -->
                          <button class="absolute left-[-40px] top-1/2 transform -translate-y-1/2 w-6 h-6 rounded-lg flex items-center justify-center bg-blue-500 bg-opacity-70 text-white hover:bg-opacity-90 transition-colors shadow-md z-10"
                                  (click)="previousSlide()" 
                                  [disabled]="currentSlideIndex === 0">
                            <mat-icon class="text-sm">chevron_left</mat-icon>
                          </button>

                          <!-- Image Display Area -->
                          <div class="image-display-area relative bg-gray-200 rounded-lg flex flex-col items-center justify-center h-40 mb-3 border-2 border-dashed border-gray-300 overflow-hidden w-full">
                            
                            <!-- Upload Prompt -->
                            <div class="upload-content text-center cursor-pointer p-4 w-full h-full flex items-center justify-center"
                                 [class.hidden]="selectedMedia.slides[currentSlideIndex].image" 
                                 (click)="openUploadModal('image')">
                              <div class="flex flex-col items-center justify-center">
                                <div class="upload-icon mb-2">
                                  <div class="w-8 h-8 mx-auto bg-blue-500 rounded-full flex items-center justify-center">
                                    <mat-icon class="text-white text-lg">image</mat-icon>
                                  </div>
                                </div>
                                <p class="text-gray-600 text-sm font-medium mb-1">Drag your image here or click</p>
                                <p class="text-gray-600 text-sm font-medium">to upload</p>
                              </div>
                            </div>

                            <!-- Slide Image Display -->
                            <div class="image-slider-display w-full h-full" *ngIf="selectedMedia.slides[currentSlideIndex].image">
                              <img [src]="selectedMedia.slides[currentSlideIndex].image" 
                                   alt="Slide Image" 
                                   class="w-full h-full object-cover rounded-lg">
                              <button class="absolute top-2 right-2 w-6 h-6 rounded-lg flex items-center justify-center bg-red-500 bg-opacity-80 text-white hover:bg-opacity-100 transition-colors shadow-md z-20"
                                      (click)="removeCurrentImage(currentSlideIndex)">
                                <mat-icon class="text-xs">delete</mat-icon>
                              </button>
                            </div>
                          </div>

                          <!-- Right Navigation / Add Slide -->
                          <button *ngIf="currentSlideIndex < (selectedMedia.slides.length - 1); else addSlideButton"
                                  class="absolute right-[-40px] top-1/2 transform -translate-y-1/2 w-6 h-6 rounded-lg flex items-center justify-center bg-blue-500 bg-opacity-70 text-white hover:bg-opacity-90 transition-colors shadow-md z-10"
                                  (click)="nextSlide()">
                            <mat-icon class="text-sm">chevron_right</mat-icon>
                          </button>

                          <ng-template #addSlideButton>
                            <button class="absolute right-[-40px] top-1/2 transform -translate-y-1/2 w-6 h-6 rounded-lg flex items-center justify-center bg-blue-500 bg-opacity-70 text-white hover:bg-opacity-90 transition-colors shadow-md z-10"
                                    (click)="addNewSlide()">
                              <mat-icon class="text-sm">add</mat-icon>
                            </button>
                          </ng-template>
                        </div>

                        <!-- Slide Title Input -->
                        <div class="slide-input-group mb-3">
                          <input type="text" 
                                 placeholder="Slide Title"
                                 class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                 [(ngModel)]="selectedMedia.slides[currentSlideIndex].title" />
                        </div>

                        <!-- Slide Subtitle Input -->
                        <div class="slide-input-group mb-3">
                          <input type="text" 
                                 placeholder="Subtitle"
                                 class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                 [(ngModel)]="selectedMedia.slides[currentSlideIndex].subtitle" />
                        </div>
                      </div>

                      <!-- Slide Indicators -->
                      <div class="slide-indicators flex justify-center gap-1 mt-4">
                        <div class="indicator w-2 h-2 rounded-full bg-gray-400 cursor-pointer transition-colors"
                             *ngFor="let slide of selectedMedia.slides; let i = index"
                             [class.bg-blue-500]="i === currentSlideIndex" 
                             (click)="goToSlide(i)">
                        </div>
                      </div>
                    </div>

                    <!-- Empty Slider State -->
                    <div class="image-slider-container bg-white rounded-lg p-3 mb-3"
                         *ngIf="!selectedMedia.slides || selectedMedia.slides.length === 0">
                      <div class="upload-content text-center cursor-pointer" (click)="addNewSlide()">
                        <p class="text-gray-600 text-sm font-medium mb-1">Click to add your first slide</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Buttons Section -->
                <div *ngIf="selectedMedia.buttons && selectedMedia.buttons.length" class="buttons-section mt-4">
                  <div *ngFor="let button of selectedMedia.buttons; let i = index" class="mb-2 flex justify-center">
                    <button class="bg-transparent text-blue-500 py-1 px-2 w-full max-w-xs rounded-lg text-xs font-semibold flex items-center justify-between border border-blue-500 hover:bg-gray-100 transition-colors">
                      <mat-icon class="text-sm" (click)="onEditButtonClick(button, i)">edit</mat-icon>
                      <span class="flex-1 px-4">{{ button.title }}</span>
                      <mat-icon class="text-sm text-red-500" (click)="onDeleteButtonClick(i)">delete</mat-icon>
                    </button>
                  </div>
                </div>

                <!-- Add Button -->
                <div class="add-button-section mb-4 flex justify-center">
                  <button class="bg-transparent text-blue-500 px-10 py-1 text-xs font-semibold flex items-center gap-2 hover:bg-blue-200 transition-colors border-2 border-dashed border-blue-300 rounded"
                          (click)="onAddNewButton()">
                    <span class="text-base font-bold">+</span>
                    ADD NEW BUTTON
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div *ngIf="showUploadModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white w-full max-w-md rounded-lg shadow-lg">
    <div class="flex justify-between items-center p-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-800">
        {{ activeMediaType === 'image' ? 'Upload Image' : activeMediaType === 'video' ? 'Upload Video' : 'Upload File' }}
      </h3>
      <button mat-icon-button (click)="closeUploadModal()" class="text-gray-500 hover:text-gray-700">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <mat-tab-group class="upload-tabs">
      <mat-tab label="Upload">
        <div class="p-4">
          <div class="flex gap-2 items-center justify-between p-4 rounded-lg">
            <button class="w-full py-2 text-sm text-gray-600 border border-gray-300 rounded truncate">
              {{ uploadedFileName || 'Choose file' }}
            </button>

            <ng-container *ngIf="activeMediaType === 'image'">
              <input #imageUploadInput type="file" accept="image/*" class="hidden" (change)="onImageUpload($event)">
              <button mat-flat-button class="!bg-green-500 !text-white !rounded-lg" (click)="imageUploadInput.click()">
                Browse
              </button>
            </ng-container>

            <ng-container *ngIf="activeMediaType === 'video'">
              <input #videoUploadInput type="file" accept="video/*" class="hidden" (change)="onVideoUpload($event)">
              <button mat-flat-button class="!bg-green-500 !text-white !rounded-lg" (click)="videoUploadInput.click()">
                Browse
              </button>
            </ng-container>

            <ng-container *ngIf="activeMediaType === 'file'">
              <input #fileUploadInput type="file" class="hidden" (change)="onFileUpload($event)">
              <button mat-flat-button class="!bg-green-500 !text-white !rounded-lg" (click)="fileUploadInput.click()">
                Browse
              </button>
            </ng-container>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="URL">
        <div class="p-4">
          <h3 class="block text-gray-700 text-sm font-medium mb-2">
            {{ activeMediaType === 'image' ? 'Image URL' : activeMediaType === 'video' ? 'Video URL' : 'File URL' }}
          </h3>
          <mat-form-field appearance="outline" class="w-full">
            <input matInput
                   [placeholder]="activeMediaType === 'image' ? 'https://example.com/image.jpg' : activeMediaType === 'video' ? 'https://example.com/video.mp4' : 'https://example.com/file.pdf'"
                   [ngModel]="activeMediaType === 'image' ? imageUrlInput : videoUrlInput"
                   (ngModelChange)="activeMediaType === 'image' ? imageUrlInput = $event : videoUrlInput = $event">
          </mat-form-field>
          <div class="flex justify-end mt-2">
            <button mat-flat-button class="!bg-green-500 !text-white !rounded-lg"
                    (click)="activeMediaType === 'image' ? uploadImageUrl() : uploadVideoUrl()">
              Upload
            </button>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>

<!-- Button Type Selection Card -->
<div class="button-type-card fixed z-50 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2" *ngIf="showButtonTypeCard">
  <div class="bg-gray-50 p-6 rounded-lg shadow-xl w-80 max-w-full">
    <div class="flex justify-between items-center mb-4">
      <h4 class="text-lg font-semibold text-gray-800">Button Type</h4>
      <button mat-icon-button (click)="closeButtonTypeCard()" class="text-gray-500 hover:text-gray-700">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <button mat-flat-button class="!text-xs py-2 !rounded-lg !bg-blue-500 !text-white hover:!bg-blue-600"
              (click)="openCommonCardForNewButton('text_message')">Text Message</button>
      <button mat-flat-button class="!text-xs py-2 !rounded-lg !bg-blue-500 !text-white hover:!bg-blue-600"
              (click)="openCommonCardForNewButton('media_block')">Send Media Block</button>
      <button mat-flat-button class="!text-xs py-2 !rounded-lg !bg-blue-500 !text-white hover:!bg-blue-600"
              (click)="openCommonCardForNewButton('website_url')">Website URL</button>
      <button mat-flat-button class="!text-xs py-2 !rounded-lg !bg-blue-500 !text-white hover:!bg-blue-600"
              (click)="openCommonCardForNewButton('direct_call')">Direct Call</button>
      <button mat-flat-button class="!text-xs py-2 !rounded-lg !bg-blue-500 !text-white hover:!bg-blue-600"
              (click)="openCommonCardForNewButton('start_story')">Start Story</button>
      <button mat-flat-button class="!text-xs py-2 !rounded-lg !bg-blue-500 !text-white hover:!bg-blue-600"
              (click)="openCommonCardForNewButton('rss_feed')">RSS Feed</button>
      <button mat-flat-button class="!text-xs py-2 !rounded-lg !bg-blue-500 !text-white hover:!bg-blue-600"
              (click)="openCommonCardForNewButton('json_api')">JSON API</button>
      <button mat-flat-button class="!text-xs py-2 !rounded-lg !bg-blue-500 !text-white hover:!bg-blue-600"
              (click)="openCommonCardForNewButton('human_help')">Human Help</button>
      <button mat-flat-button class="!text-xs py-2 !rounded-lg !bg-blue-500 !text-white hover:!bg-blue-600"
              (click)="openCommonCardForNewButton('conversational_form')">Conversational Form</button>
    </div>
  </div>
</div>

<!-- Button Integration Card -->
<div class="common-integration-card fixed z-50 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-96 p-4 bg-white rounded-lg shadow-xl border border-gray-200"
     *ngIf="showCommonIntegrationCard">
  
  <div class="flex justify-between items-center mb-4">
    <h4 class="text-lg font-medium uppercase text-gray-500">
      <ng-container [ngSwitch]="currentButton.type">
        <span *ngSwitchCase="'text_message'">Text Message Integration</span>
        <span *ngSwitchCase="'media_block'">Media Block Integration</span>
        <span *ngSwitchCase="'website_url'">Website URL Integration</span>
        <span *ngSwitchCase="'direct_call'">Direct Call Integration</span>
        <span *ngSwitchCase="'start_story'">Story Integration</span>
        <span *ngSwitchCase="'rss_feed'">RSS Integration</span>
        <span *ngSwitchCase="'json_api'">JSON Integration</span>
        <span *ngSwitchCase="'human_help'">Human Help Integration</span>
        <span *ngSwitchCase="'conversational_form'">Conversational Form Integration</span>
        <span *ngSwitchDefault>Button Integration</span>
      </ng-container>
    </h4>
    <button mat-icon-button (click)="closeCommonIntegrationCard()" class="text-gray-500 hover:text-gray-700">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Button Title -->
  <div class="input-group mb-4">
    <h3 class="text-sm mb-1 font-semibold text-gray-600">Title of the button *</h3>
    <mat-form-field appearance="outline" class="w-full">
      <textarea matInput 
                placeholder="e.g. Show another product" 
                [(ngModel)]="currentButton.title" 
                maxlength="20"
                cdkTextareaAutosize 
                #buttonTitleAutosize="cdkTextareaAutosize" 
                cdkAutosizeMinRows="1" 
                cdkAutosizeMaxRows="2"
                class="resize-none"></textarea>
      <mat-hint align="end">{{ currentButton.title ? currentButton.title.length : 0 }} / 20</mat-hint>
    </mat-form-field>
  </div>

  <!-- Button Content Based on Type -->
  <ng-container [ngSwitch]="currentButton.type">
    
    <!-- Text Message -->
    <div *ngSwitchCase="'text_message'" class="input-group mb-4">
      <h3 class="text-sm mb-1 font-semibold text-gray-600">Bot says *</h3>
      <mat-form-field appearance="outline" class="w-full">
        <textarea matInput 
                  placeholder="Welcome, I am Leo, I can help you discover cheapest concert tickets" 
                  rows="2"
                  [(ngModel)]="currentButton.textMessage" 
                  maxlength="320" 
                  cdkTextareaAutosize
                  #buttonTextMessageAutosize="cdkTextareaAutosize" 
                  cdkAutosizeMinRows="2" 
                  cdkAutosizeMaxRows="8"
                  class="max-h-20 overflow-y-auto resize-none"></textarea>
        <mat-hint align="end">{{ currentButton.textMessage ? currentButton.textMessage.length : 0 }} / 320</mat-hint>
        <mat-icon matSuffix class="info-icon cursor-pointer" (click)="openInfoModal('buttonTextMessage')">info</mat-icon>
      </mat-form-field>
    </div>

    <!-- Media Block Selection -->
    <div *ngSwitchCase="'media_block'" class="input-group mb-4">
      <h3 class="text-sm mb-1 font-semibold text-gray-600">Select Media Block *</h3>
      <mat-form-field appearance="outline" class="w-full">
        <mat-select [(ngModel)]="currentButton.linkedMediaId">
          <mat-option [value]="undefined">No media block selected</mat-option>
          <mat-option *ngFor="let media of availableMedia" [value]="media.id">
            {{ media.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Website URL -->
    <div *ngSwitchCase="'website_url'" class="input-group mb-4">
      <h3 class="text-sm mb-1 font-semibold text-gray-600">Weblink on button click *</h3>
      <mat-form-field appearance="outline" class="w-full">
        <input matInput placeholder="e.g. https://www.example.com" [(ngModel)]="currentButton.url">
      </mat-form-field>
    </div>

    <!-- Direct Call -->
    <div *ngSwitchCase="'direct_call'" class="input-group mb-4">
      <h3 class="text-sm mb-1 font-semibold text-gray-600">Phone number *</h3>
      <mat-form-field appearance="outline" class="w-full">
        <input matInput placeholder="e.g. +15105551234" [(ngModel)]="currentButton.phoneNumber">
      </mat-form-field>
    </div>

    <!-- Start Story -->
    <div *ngSwitchCase="'start_story'" class="input-group mb-4">
      <h3 class="text-sm mb-1 font-semibold text-gray-600">Select story to initiate *</h3>
      <mat-form-field appearance="outline" class="w-full">
        <mat-select [(ngModel)]="currentButton.storyId">
          <mat-option [value]="undefined">No story selected</mat-option>
          <mat-option *ngFor="let story of availableStories" [value]="story.id">
            {{ story.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- RSS Feed -->
    <ng-container *ngSwitchCase="'rss_feed'">
      <div class="input-group mb-4">
        <h3 class="text-sm mb-1 font-semibold text-gray-600">RSS Feed URL *</h3>
        <mat-form-field appearance="outline" class="w-full">
          <input matInput placeholder="Your RSS feed URL" [(ngModel)]="currentButton.rssUrl">
        </mat-form-field>
      </div>

      <div class="input-group mb-4">
        <h3 class="text-sm mb-1 font-semibold text-gray-600">Number of items to show *</h3>
        <mat-form-field appearance="outline" class="w-full">
          <input matInput type="number" placeholder="e.g. 5" [(ngModel)]="currentButton.rssItemCount">
        </mat-form-field>
      </div>

      <div class="input-group mb-4">
        <h3 class="text-sm mb-1 font-semibold text-gray-600">Button Text *</h3>
        <mat-form-field appearance="outline" class="w-full">
          <input matInput placeholder="e.g. View Now!" [(ngModel)]="currentButton.rssButtonText">
        </mat-form-field>
      </div>
    </ng-container>

    <!-- JSON API -->
    <ng-container *ngSwitchCase="'json_api'">
      <div class="input-group mb-4">
        <h3 class="text-sm mb-1 font-semibold text-gray-600">API Endpoint *</h3>
        <mat-form-field appearance="outline" class="w-full">
          <input matInput type="url" [(ngModel)]="currentButton.apiEndpoint" placeholder="Enter Your API Endpoint" />
        </mat-form-field>
      </div>

      <div class="input-group mb-4">
        <h3 class="text-sm mb-1 font-semibold text-gray-600">Select Request Type *</h3>
        <mat-form-field appearance="outline" class="w-full">
          <mat-select [(ngModel)]="currentButton.requestType" placeholder="Select Request Type">
            <mat-option value="POST">POST</mat-option>
            <mat-option value="GET">GET</mat-option>
            <mat-option value="PUT">PUT</mat-option>
            <mat-option value="DELETE">DELETE</mat-option>
            <mat-option value="PATCH">PATCH</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="headers-section mb-4">
        <h4 class="font-semibold text-sm text-gray-600 mb-2">Select Headers</h4>
        
        <div class="header-item flex items-center gap-2 mb-2" *ngFor="let header of currentButton.apiHeaders; let i = index">
          <mat-form-field appearance="outline" class="flex-1">
            <input matInput [(ngModel)]="header.key" placeholder="Header Key" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="flex-1">
            <input matInput [(ngModel)]="header.value" placeholder="Header Value" />
          </mat-form-field>

          <button mat-icon-button color="warn" (click)="removeApiHeader(i)" matTooltip="Remove Header">
            <mat-icon>delete</mat-icon>
          </button>
        </div>

        <button mat-flat-button class="!bg-blue-500 !text-white w-full" (click)="addApiHeader()">
          <mat-icon>add</mat-icon>
          Add Header
        </button>
      </div>
    </ng-container>

    <!-- Human Help -->
    <ng-container *ngSwitchCase="'human_help'">
      <div class="input-group mb-4">
        <h3 class="text-sm mb-1 font-semibold text-gray-600">Message After Help Action *</h3>
        <mat-form-field appearance="outline" class="w-full">
          <input matInput placeholder="Bot Says" [(ngModel)]="currentButton.messageAfterAction">
        </mat-form-field>
      </div>

      <div class="input-group mb-4">
        <h3 class="text-sm mb-1 font-semibold text-gray-600">Email for Notification</h3>
        <mat-form-field appearance="outline" class="w-full">
          <input matInput placeholder="Enter Email" [(ngModel)]="currentButton.emailForNotification">
        </mat-form-field>
        <p class="text-xs text-gray-500 mt-1">Note: Send notifications to multiple emails, press enter to add email.</p>
      </div>

      <div class="flex items-center mt-4">
        <mat-slide-toggle [(ngModel)]="currentButton.stopBotForUser" class="mr-2"></mat-slide-toggle>
        <span>Stop Bot For User</span>
      </div>
    </ng-container>

    <!-- Conversational Form -->
    <ng-container *ngSwitchCase="'conversational_form'">
      <div class="input-group mb-4">
        <h3 class="text-sm mb-1 font-semibold text-gray-600">Select Form *</h3>
        <mat-form-field appearance="outline" class="w-full">
          <mat-select [(ngModel)]="currentButton.formId">
            <mat-option value="form1">Default Form 9405</mat-option>
            <mat-option value="form2">Another Form</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="flex items-center mt-4">
        <mat-slide-toggle [(ngModel)]="currentButton.showInline"></mat-slide-toggle>
        <span class="ml-2">Show as inline form</span>
        <mat-icon matTooltip="Display the form directly in the chat window." class="ml-1 text-gray-500">info</mat-icon>
      </div>
    </ng-container>
  </ng-container>

  <!-- Save Button -->
  <div class="flex justify-start mt-6">
    <button mat-flat-button
            class="!bg-blue-500 !text-white h-8 px-4 !rounded-lg font-medium"
            (click)="saveCommonIntegrationCard()">
      {{ currentButtonIndex === -1 ? 'Add' : 'Update' }}
    </button>
  </div>
</div>

<!-- Info Modal for Variables -->
<div class="info-modal fixed z-[60] inset-0 flex items-center justify-center bg-black bg-opacity-50" 
     *ngIf="showInfoModal" 
     (click)="closeInfoModal()">
  
  <div class="info-modal-card bg-white border p-4 rounded-lg shadow-xl w-80 max-w-full" 
       (click)="$event.stopPropagation()">
    
    <!-- Search Box -->
    <div class="search-box mb-4">
      <mat-form-field appearance="outline" class="w-full">
        <input matInput 
               placeholder="search variable..." 
               type="text" 
               [(ngModel)]="searchTerm"
               (ngModelChange)="filterVariables()">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>
    </div>

    <!-- Variable Lists -->
    <div class="variable-lists max-h-64 overflow-y-auto">
      
      <!-- General Attributes -->
      <div class="variable-list-group mb-4" *ngIf="filteredGeneralAttributes.length > 0">
        <h5 class="text-xs font-medium text-gray-700 mb-2">General Attributes</h5>
        <div class="grid grid-cols-2 gap-2">
          <button mat-flat-button
                  class="!justify-start !text-xs !text-blue-500 py-1 !rounded-lg !bg-blue-100 !border !border-blue-300 hover:!bg-blue-200"
                  *ngFor="let attr of filteredGeneralAttributes" 
                  (click)="selectVariable(attr)">
            {{ attr }}
          </button>
        </div>
      </div>

      <!-- Form Attributes -->
      <div class="variable-list-group mb-4" *ngIf="filteredFormAttributes.length > 0">
        <h5 class="text-xs font-medium text-gray-700 mb-2">Form Attributes</h5>
        <div class="grid grid-cols-1 gap-2">
          <button mat-flat-button
                  class="!justify-start !text-xs !text-blue-500 py-1 !rounded-lg !bg-blue-100 !border !border-blue-300 hover:!bg-blue-200"
                  *ngFor="let attr of filteredFormAttributes" 
                  (click)="selectVariable(attr)">
            {{ attr }}
          </button>
        </div>
      </div>

      <!-- User Attributes -->
      <div class="variable-list-group mb-4" *ngIf="filteredUserAttributes.length > 0">
        <h5 class="text-xs font-medium text-gray-700 mb-2">User Attributes</h5>
        <div class="grid grid-cols-2 gap-2">
          <button mat-flat-button
                  class="!justify-start !text-xs !text-blue-500 py-1 !rounded-lg !bg-blue-100 !border !border-blue-300 hover:!bg-blue-200"
                  *ngFor="let attr of filteredUserAttributes" 
                  (click)="selectVariable(attr)">
            {{ attr }}
          </button>
        </div>
      </div>

      <!-- No Results -->
      <div *ngIf="filteredGeneralAttributes.length === 0 && filteredFormAttributes.length === 0 && filteredUserAttributes.length === 0">
        <p class="text-center text-xs text-gray-500 italic">No variables found.</p>
      </div>
    </div>
  </div>
</div>

<!-- Hidden File Inputs -->
<input type="file" #fileUploadInput style="display: none;" (change)="onFileUpload($event)">
<input type="file" #audioUploadInput accept="audio/*" style="display: none;" (change)="onAudioUpload($event)">
<input type="file" #videoUploadInput accept="video/*" style="display: none;" (change)="onVideoUpload($event)">
<input type="file" #imageUploadInput accept="image/*" style="display: none;" (change)="onImageUpload($event)">