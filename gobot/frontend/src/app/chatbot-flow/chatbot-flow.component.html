<div class="chatbot-flow-container">
  <div class="header">
    <div class="header-left">
      <h2>{{ isEditMode ? 'Edit Story' : 'Create Story' }}</h2>
    </div>
    <div class="header-actions">
      <button mat-button (click)="onCancel()" class="cancel-button">
        Cancel
      </button>
      <button mat-raised-button color="primary" class="save-button" (click)="saveFlow()">
        Save
      </button>
    </div>
  </div>

  <div class="main-content">
    <div class="left-sidebar">
      <div class="sidebar-header">
        <p class="instruction-text">
          Drag blocks to the canvas to build your flow
        </p>
      </div>

      <div class="search-container">
        <mat-form-field class="search-field">
          <mat-icon matPrefix>search</mat-icon>
          <input matInput placeholder="Search blocks..." [formControl]="searchControl" />
        </mat-form-field>
      </div>

      <div class="blocks-list" cdkDropList>
        <div *ngFor="let block of filteredBlocks$ | async" class="block-item enhanced-drag-item" cdkDrag
          [cdkDragData]="block" (cdkDragStarted)="onPaletteDragStarted($event)"
          (cdkDragEnded)="onPaletteDragEnded($event, block)">
          <div class="block-icon">
            <img *ngIf="block.imageUrl" [src]="block.imageUrl" alt="block-icon"
              class="custom-icon shadow-sm border border-gray-200 rounded">
            <mat-icon *ngIf="!block.imageUrl">{{ block.icon }}</mat-icon>
          </div>

          <div class="block-content flex items-center">
            <div class="block-name">{{ block.name }}</div>
            <div *ngIf="block.description"
              class="block-description ml-2 px-1.5 py-1 rounded-md bg-green-500 text-white text-xs font-semibold">
              {{ block.description }}
            </div>
          </div>

          <div class="drag-handle enhanced-drag-handle">
            <mat-icon>drag_indicator</mat-icon>
          </div>

          <div *cdkDragPreview class="drag-preview-block">
            <div class="drag-preview-content">
              <div class="drag-preview-icon">
                <img *ngIf="block.imageUrl" [src]="block.imageUrl" alt="block-icon" class="preview-icon-img">
                <mat-icon *ngIf="!block.imageUrl">{{ block.icon }}</mat-icon>
              </div>
              <div class="drag-preview-text">
                <div class="drag-preview-name">{{ block.name }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="canvas-area" [class.sidebar-open]="rightSidebarOpen">
      <div class="canvas-controls">
        <div class="zoom-controls">
          <button mat-icon-button (click)="zoomIn()" [disabled]="zoomLevel >= maxZoom" matTooltip="Zoom In">
            <mat-icon class="mt-2 mr-0.9">add</mat-icon>
          </button>
          <span class="zoom-level">{{ zoomLevel * 100 | number : "1.0-0" }}%</span>
          <button mat-icon-button (click)="zoomOut()" [disabled]="zoomLevel <= minZoom" matTooltip="Zoom Out">
            <mat-icon class="mt-2 mr-0.9">remove</mat-icon>
          </button>
        </div>
        <button mat-icon-button (click)="resetZoom()" matTooltip="Reset zoom and pan">
          <span class="reset-text">Reset</span>
        </button>
      </div>

      <div class="canvas-wrapper bg-[#F1F2F3] enhanced-drop-zone" #canvasWrapper
        [style.cursor]="isPanning ? 'grabbing' : 'default'" (wheel)="onWheel($event)">
        <div class="drop-zone-indicator" [class.visible]="isDraggingFromPalette">
          <div class="drop-zone-content">
          </div>
        </div>

        <div class="canvas-content" #canvasContent id="canvas">
          <div class="flow-start-indicator">
            <div class="flow-start-text">Flow starts here</div>
            <div class="flow-start-arrow">
              <mat-icon>arrow_downward</mat-icon>
            </div>
          </div>

          <div class="blocks-container">
            <div *ngFor="let block of canvasBlocks" class="canvas-block jsplumb-draggable enhanced-canvas-block"
              [id]="'block-' + block.id" [class]="'canvas-block-' + block.type"
              [class.selected]="selectedBlock?.id === block.id" [style.left.px]="block.x" [style.top.px]="block.y"
              [style.position]="'absolute'" [style.border-color]="getStatusColor(block.status)"
              [style.background-color]="getTypeColor(block.type)" [style.opacity]="block.isInitializing ? 0 : 1"
              [style.transition]="block.isInitializing ? 'none' : 'opacity 0.2s ease-in'">

              <ng-container [ngSwitch]="block.type">
                <app-user-input-block *ngSwitchCase="'userInput'" [block]="block"
                  [attr.id]="'user-input-block-' + block.id" [isSelected]="selectedBlock?.id === block.id"
                  [isSidebarOpen]="rightSidebarOpen" (blockUpdated)="onBlockUpdated($event)"
                  (selectBlock)="selectBlock($event)" (removeBlock)="removeCanvasBlock($event)"
                  (duplicateBlock)="duplicateCanvasBlock($event)" (editBlock)="editCanvasBlock($event)"
                  (addKeywordGroupBlock)="onAddKeywordGroupBlockToCanvas()"></app-user-input-block>

                <app-text-response-block *ngSwitchCase="'textResponse'" [block]="block"
                  [isSelected]="selectedBlock?.id === block.id" [isSidebarOpen]="rightSidebarOpen"
                  (blockUpdated)="onBlockUpdated($event)" (selectBlock)="selectBlock($event)"
                  (removeBlock)="removeCanvasBlock($event)" (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"
                  (addKeywordGroupBlock)="onAddKeywordGroupBlockToCanvas()"></app-text-response-block>

                <app-media-block *ngSwitchCase="'mediaBlock'" [attr.id]="'media-block-' + block.id" [block]="block"
                  [isSelected]="selectedBlock?.id === block.id" [isSidebarOpen]="rightSidebarOpen"
                  [availableMedia]="availableMedia" [availableStories]="availableStories"
                  (blockUpdated)="onBlockUpdated($event)" (selectBlock)="selectBlock($event)"
                  (removeBlock)="removeCanvasBlock($event)" (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"></app-media-block>

                <app-link-story-block *ngSwitchCase="'linkStory'" [block]="block"
                  [isSelected]="selectedBlock?.id === block.id" [isSidebarOpen]="rightSidebarOpen"
                  [availableStories]="availableStories" (blockUpdated)="onBlockUpdated($event)"
                  (selectBlock)="selectBlock($event)" (removeBlock)="removeCanvasBlock($event)"
                  (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"></app-link-story-block>

                <app-conversational-form-block *ngSwitchCase="'conversationalForm'" [block]="block"
                  [isSelected]="selectedBlock?.id === block.id" [isSidebarOpen]="rightSidebarOpen"
                  [availableForms]="availableForms" (blockUpdated)="onBlockUpdated($event)"
                  (selectBlock)="selectBlock($event)" (removeBlock)="removeCanvasBlock($event)"
                  (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"></app-conversational-form-block>

                <app-typing-delay-block *ngSwitchCase="'typingDelay'" [block]="block"
                  [isSelected]="selectedBlock?.id === block.id" [isSidebarOpen]="rightSidebarOpen"
                  (blockUpdated)="onBlockUpdated($event)" (selectBlock)="selectBlock($event)"
                  (removeBlock)="removeCanvasBlock($event)" (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)"></app-typing-delay-block>
                
                <app-json-api-integration-block *ngSwitchCase="'jsonApi'" [block]="block" 
                  [isSelected]="selectedBlock?.id === block.id" [isSidebarOpen]="rightSidebarOpen"
                  (blockUpdated)="onBlockUpdated($event)" (selectBlock)="selectBlock($event)" 
                  (removeBlock)="removeCanvasBlock($event)" (duplicateBlock)="duplicateCanvasBlock($event)"
                  (editBlock)="editCanvasBlock($event)">
                </app-json-api-integration-block>

              </ng-container>
            </div>

            <div *ngFor="let block of canvasBlocks" class="quick-reply-cards-wrapper"
              [class.hidden]="block.type !== 'textResponse' || !block.quickReplies || block.quickReplies.length === 0"
              [style.left.px]="(block.x || 0) - 120" [style.top.px]="(block.y || 0) + (block.height || 0) + 10"
              [attr.data-parent-id]="block.id">
              <div class="qr-parent-connector" [style.left.px]="120 + (block.width ? (block.width / 2) : 160)"
                [style.top.px]="0" [style.height.px]="30"></div>
              <app-quick-reply-flow [quickReplies]="block.quickReplies || []" [parentBlockId]="block.id"
                (startConnection)="onQuickReplyStartConnection($event)"></app-quick-reply-flow>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="right-sidebar" [class.open]="rightSidebarOpen" *ngIf="selectedBlock">
      <div class="right-sidebar-header">
        <div class="sidebar-title">
          <mat-icon>{{ selectedBlock.icon }}</mat-icon>
          <span>{{ selectedBlock.name }}</span>
        </div>
        <button mat-icon-button (click)="closeSidebar()" class="close-btn">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="right-sidebar-content-wrapper">
        <ng-container [ngSwitch]="selectedBlock.type">
          <app-user-input-block *ngSwitchCase="'userInput'" [block]="selectedBlock" [isSelected]="true"
            [isSidebarOpen]="true" (blockUpdated)="onBlockUpdated($event)" (closeSidebarEvent)="closeSidebar()"
            (editBlock)="editCanvasBlock($event)"></app-user-input-block>

          <app-text-response-block *ngSwitchCase="'textResponse'" [block]="selectedBlock" [isSelected]="true"
            [isSidebarOpen]="true" (blockUpdated)="onBlockUpdated($event)" (closeSidebarEvent)="closeSidebar()"
            (editBlock)="editCanvasBlock($event)"></app-text-response-block>

          <app-media-block *ngSwitchCase="'mediaBlock'" [block]="selectedBlock" [isSelected]="true"
            [isSidebarOpen]="true" [availableMedia]="availableMedia" [availableStories]="availableStories"
            (closeSidebarEvent)="closeSidebar()" (blockUpdated)="onBlockUpdated($event)"></app-media-block>

          <app-link-story-block *ngSwitchCase="'linkStory'" [block]="selectedBlock" [isSelected]="true"
            [isSidebarOpen]="true" [availableStories]="availableStories"
            (blockUpdated)="onBlockUpdated($event)"></app-link-story-block>

          <ng-container *ngSwitchCase="'conversationalForm'">
    
    <app-conversational-form-block
        [block]="selectedBlock"
        [isSelected]="true"
        [isSidebarOpen]="true"
        [availableForms]="availableForms"
        (blockUpdated)="onBlockUpdated($event)"
    ></app-conversational-form-block>

    <!-- ðŸ‘‡ ADD THE NEW TEST BUTTON HERE ðŸ‘‡ -->
    <div style="padding: 0 20px 20px 20px; margin-top: 10px;">
        <button 
            mat-raised-button 
            color="accent" 
            (click)="testAddConversationalForm(selectedBlock!)"
            style="width: 100%;"
        >
            Test This Conversational Form
        </button>
    </div>

</ng-container>
          
          <!-- START: TYPING DELAY BLOCK WITH TEST BUTTON -->
          <ng-container *ngSwitchCase="'typingDelay'">
            <app-typing-delay-block 
              [block]="selectedBlock" 
              [isSelected]="true"
              [isSidebarOpen]="true" 
              (blockUpdated)="onBlockUpdated($event)">
            </app-typing-delay-block>
            
            <div style="padding: 0 20px 20px 20px; margin-top: 10px;">
              <button 
                  mat-raised-button 
                  color="accent" 
                  (click)="testAddTypingDelayProto(selectedBlock!)"
                  style="width: 100%;"
              >
                  Test This Typing Delay
              </button>
            </div>
          </ng-container>
          <!-- END: TYPING DELAY BLOCK WITH TEST BUTTON -->

          <!-- START: JSON API BLOCK WITH TEST BUTTON -->
          <ng-container *ngSwitchCase="'jsonApi'">
            <app-json-api-integration-block 
              [block]="selectedBlock" 
              [isSelected]="true"
              (blockUpdated)="onBlockUpdated($event)">
            </app-json-api-integration-block>

            <div style="padding: 0 20px 20px 20px; margin-top: 10px;">
              <button 
                  mat-raised-button 
                  color="accent" 
                  (click)="testAddJsonApi(selectedBlock!)"
                  style="width: 100%;"
              >
                  Test This JSON API Block
              </button>
            </div>
          </ng-container>
          <!-- END: JSON API BLOCK WITH TEST BUTTON -->

        </ng-container>
      </div>
    </div>

    <div class="sidebar-overlay" [class.active]="rightSidebarOpen" (click)="closeSidebar()"></div>
  </div>

  <app-jarvish-block *ngIf="isJarvisVisible" [availableStories]="availableStories" [canvasBlocks]="canvasBlocks"
    [availableMedia]="availableMedia"></app-jarvish-block>
  <button
    class="absolute right-10 bottom-8 w-14 h-14 flex items-center justify-center bg-[#2563eb] rounded-full shadow-lg cursor-pointer z-[100000] overflow-hidden"
    (click)="toggleJarvis()">

    <svg *ngIf="!isJarvisVisible" version="1.0" xmlns="http://www.w3.org/2000/svg" width="34" height="34"
      viewBox="0 0 96 96" fill="white" class="skew-down-fade">
      <g transform="translate(0,96) scale(0.1,-0.1)" stroke="none">
        <path
          d="M105 855 l-25 -24 0 -278 0 -277 63 62 63 62 212 0 c283 0 262 -19 262 240 0 189 0 191 -25 215 l-24 25 -251 0 -251 0 -24 -25z">
        </path>
        <path
          d="M720 569 c0 -197 -16 -209 -269 -209 l-171 0 0 -55 c0 -46 4 -60 25 -80 l24 -25 218 0 217 0 58 -57 58 -57 0 272 0 273 -25 24 c-20 21 -34 25 -80 25 l-55 0 0 -111z">
        </path>
      </g>
    </svg>

    <svg *ngIf="isJarvisVisible" xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 17 17"
      fill="white" class="rotate-in">
      <path
        d="M9.207 8.5l6.646 6.646-.707.707L8.5 9.207l-6.646 6.646-.707-.707L7.793 8.5 1.146 1.854l.707-.707L8.5 7.793l6.646-6.646.707.707L9.207 8.5z">
      </path>
    </svg>

  </button>
</div>

